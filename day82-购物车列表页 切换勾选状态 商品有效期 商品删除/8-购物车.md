# 购物车实现

## 根据课程有效期调整价格

要实现课程有效期的计算，则必须我们要清楚一个课程可以有1到多个有效期选项。默认保存在课程模型中的价格如果有值，则这个值是永久有效的购买价格。如果有别的购买期限，则我们需要另行创建一个模型来保存！

course/models.py，代码：

```python
class CourseExpire(BaseModel):
    """课程有效期模型"""
    # 后面必须在数据库把course和expire_time字段设置为联合索引
    course = models.ForeignKey("Course", related_name='course_expire', on_delete=models.CASCADE,
                               verbose_name="课程名称")
    expire_time = models.IntegerField(verbose_name="有效期", null=True, blank=True,help_text="有效期按天数计算")
    expire_text = models.CharField(max_length=150, verbose_name="提示文本", null=True, blank=True)
    price = models.DecimalField(max_digits=6, decimal_places=2, verbose_name="课程价格", default=0)

    class Meta:
        db_table = "ly_course_expire"
        verbose_name = "课程有效期"
        verbose_name_plural = verbose_name

    def __str__(self):
        return "课程：%s，有效期：%s，价格：%s" % (self.course, self.expire_text, self.price)
```

注册到xadmin中，course/adminx.py，代码：

```python
from .models import CourseExpire
class CourseExpireModelAdmin(object):
    """商品有效期模型"""
    pass
xadmin.site.register(CourseExpire, CourseExpireModelAdmin)
```

数据迁移

```shell
python manage.py makemigrations
python manage.py migrate
```

添加测试数据

```sql
INSERT INTO `ly_course_expire`
(`orders`,`is_show`,`is_deleted`,`created_time`,`updated_time`,`expire_time`,`expire_text`,`course_id`,`price`)
VALUES
(1,1,0,'2019-08-19 02:05:22.368823','2019-08-19 02:05:22.368855',30,'一个月有效',2,398.00),
(2,1,0,'2019-08-19 02:05:37.397205','2019-08-19 02:05:37.397233',60,'2个月有效',2,588.00),
(3,1,0,'2019-08-19 02:05:57.029411','2019-08-19 02:05:57.029440',180,'半年内有效',2,1000.00),
(4,1,0,'2019-08-19 02:07:29.066617','2019-08-19 02:08:29.156730',3,'3天内有效',3,0.88),
(3,1,0,'2019-08-19 02:07:46.120827','2019-08-19 02:08:18.652452',30,'1个月有效',3,188.00),
(3,1,0,'2019-08-19 02:07:59.876421','2019-08-19 02:07:59.876454',60,'2个月有效',3,298.00);
```



目前我们已经在后端实现了课程有效期的模型以后，这个有效期的价格并没有纳入到真实价格的计算当中。

![1558425412138](assets/1558425412138.png)

在购物车中的商品有效期选项中，把当前课程对应的有效期选项列表展示出来。



course/models.py，Course模型中新增一个字段方法用于获取当前课程的有效期选项列表, 代码：

```python
    @property  #装饰器，property 可以把方法变成属性
    def get_expire_list(self):
        """当前课程所属的有效期选项"""
        data_list = []
        # 1. 先获取课程有效期选项的价格列表
        expire_list = self.course_expire.filter(is_show=True, is_deleted=False)
        for item in expire_list:
            data_list.append({
                "expire_time": item.expire_time,
                "expire_text": item.expire_text,
                "price": item.price,
            })

        # 2. 再获取当前课程的价格
        if self.price > 0:
            data_list.append({
                "expire_time": 0,
                "expire_text": "永久有效",
                "price": self.price,
            })

        return data_list
```



cart/views.py，新增返回expire_list有效期选项列表以及当前购物车中的有效期选项，代码：

```js
#解决小bug
expire_time = int(expire_time_bytes.decode())

"expire_list": course.get_expire_list, #当前商品客户课程所有的有效期选项列表
"expire": expire_time, #数据库中保存的商品有效期
```



```python
    def get(self,request):
        """购物车商品列表"""
        # 1.获取当前用户的id
        user_id = request.user.id

        # 2.在redis中获取当前用户的购物车商品信息
        redis_conn = get_redis_connection("cart")

        cart_hash = redis_conn.hgetall("cart_%s" % user_id)
        selected_set = redis_conn.smembers("selected_%s" % user_id)

        # 要返回给客户端的数据
        data = []

        # 3.在mysql中根据购物车的商品id获取商品其他详细信息
        for course_id_bytes, expire_time_bytes in cart_hash.items():
            course_id = course_id_bytes.decode()
            expire_time = int( expire_time_bytes.decode() )
            try:
                course = Course.objects.get(pk=course_id)
                data.append({
                    "course_id": course.id,
                    "course_img": constants.SERVER_IMAGE_URL + course.course_img.url, # 返回图片的url地址
                    "course_name": course.name,
                    "price": course.price,
                    "selected": True if course_id_bytes in selected_set else False,
                    "expire_list": course.get_expire_list, # 当前商品课程所有的有效期选项列表
                    "expire": expire_time, # 购物车中当前商品的勾选有效期
                })
            except Course.DoesNotExist:
                pass

        # 4.返回数据给客户端
        return Response(data)
```



客户端中获取到数据以后，展示有效期选项：

```html
<el-select v-model="course.expire" size="mini" placeholder="请选择购买有效期" class="my_el_select">
	<el-option v-for="item in course.expire_list" :label="item.expire_text" :value="item.expire_time" :key="item.expire_time"></el-option>
</el-select>
```

CartItem.vue

```python
<template>
    <div class="cart_item">
      <div class="cart_column column_1">
        <el-checkbox class="my_el_checkbox" v-model="course.selected"></el-checkbox>
      </div>
      <div class="cart_column column_2">
        <img :src="course.course_img" alt="">
        <span><router-link :to="`/course/${course.course_id}`">{{course.course_name}}</router-link></span>
      </div>
      <div class="cart_column column_3">
        <el-select v-model="course.expire" size="mini" placeholder="请选择购买有效期" class="my_el_select">
          <el-option v-for="item in course.expire_list" :label="item.expire_text" :value="item.expire_time" :key="item.expire_time"></el-option>
        </el-select>
      </div>
      <div class="cart_column column_4">¥{{course.price.toFixed(2)}}</div>
      <div class="cart_column column_4">删除</div>
    </div>
</template>

<script>
export default {
    name: "CartItem",
    props:["course","token"],
    data(){
      return {
        checked:false
      }
    },
    watch:{
        "course.selected": function(){
            // 当用户切换商品勾选状态时，同步到服务端
            this.change_course_status();
        }
    },
    methods:{
        change_course_status(){
            // 切换商品的勾选状态
            this.$axios.put(`${this.$settings.Host}/cart/`,{
                course_id: this.course.course_id,
                selected: this.course.selected,
            },{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
                this.$message.success("切换勾选状态成功！");
            }).catch(error=>{
                this.$message.error("切换勾选状态失败！");
            });
        }
    }
}
</script>

<style scoped>
.cart_item::after{
  content: "";
  display: block;
  clear: both;
}
.cart_column{
  float: left;
  height: 250px;
}
.cart_item .column_1{
  width: 88px;
  position: relative;
}
.my_el_checkbox{
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 0;
  margin: auto;
  width: 16px;
  height: 16px;
}
.cart_item .column_2 {
  padding: 67px 10px;
  width: 520px;
  height: 116px;
}
.cart_item .column_2 img{
  width: 175px;
  height: 115px;
  margin-right: 35px;
  vertical-align: middle;
}
.cart_item .column_3{
  width: 197px;
  position: relative;
  padding-left: 10px;
}
.my_el_select{
  width: 117px;
  height: 28px;
  position: absolute;
  top: 0;
  bottom: 0;
  margin: auto;
}
.cart_item .column_4{
  padding: 67px 10px;
  height: 116px;
  width: 142px;
  line-height: 116px;
}

</style>
```



有了有效期选项列表以后，我们就可以实现，当用户切换有效期选项以后，同步更新redis中购物车商品的有效期值。

## 切换有效期选项的API接口

客户端中实现切换不同有效期选项的时候,改动当前课程对应的价格,CartItem.vue,代码:

```js
watch:{
    "course.expire": function(){
        // 当用户切换商品有效期时，切换对应选项的价格显示在页面中,并同步到服务端
        this.change_course_expire();
    }
}, 
    
methods:{
    change_course_expire(){
        // 切换商品的有效期选项
        for(let item of this.course.expire_list ){
            if(item.expire_time === this.course.expire){
            this.course.price = item.price;
        }
    }
}

```



```vue
<template>
    <div class="cart_item">
      <div class="cart_column column_1">
        <el-checkbox class="my_el_checkbox" v-model="course.selected"></el-checkbox>
      </div>
      <div class="cart_column column_2">
        <img :src="course.course_img" alt="">
        <span><router-link :to="`/course/${course.course_id}`">{{course.course_name}}</router-link></span>
      </div>
      <div class="cart_column column_3">
        <el-select v-model="course.expire" size="mini" placeholder="请选择购买有效期" class="my_el_select">
          <el-option v-for="item in course.expire_list" :label="item.expire_text" :value="item.expire_time" :key="item.expire_time"></el-option>
        </el-select>
      </div>
      <div class="cart_column column_4">¥{{course.price.toFixed(2)}}</div>
      <div class="cart_column column_4">删除</div>
    </div>
</template>

<script>
export default {
    name: "CartItem",
    props:["course","token"],
    data(){
      return {
        checked:false
      }
    },
    watch:{
        "course.selected": function(){
            // 当用户切换商品勾选状态时，同步到服务端
            this.change_course_status();
        },
        "course.expire": function(){
            // 当用户切换商品有效期时，切换对应选项的价格显示在页面中,并同步到服务端
            this.change_course_expire();
        }
    },
    methods:{
        change_course_status(){
            // 切换商品的勾选状态
            this.$axios.put(`${this.$settings.Host}/cart/`,{
                course_id: this.course.course_id,
                selected: this.course.selected,
            },{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
                this.$message.success("切换勾选状态成功！");
            }).catch(error=>{
                this.$message.error("切换勾选状态失败！");
            });
        },
        change_course_expire(){
            // 切换商品的有效期选项
            for(let item of this.course.expire_list ){
               if(item.expire_time === this.course.expire){
                  this.course.price = item.price;
               }
            }
        }
    }
}
</script>

<style scoped>
.cart_item::after{
  content: "";
  display: block;
  clear: both;
}
.cart_column{
  float: left;
  height: 250px;
}
.cart_item .column_1{
  width: 88px;
  position: relative;
}
.my_el_checkbox{
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 0;
  margin: auto;
  width: 16px;
  height: 16px;
}
.cart_item .column_2 {
  padding: 67px 10px;
  width: 520px;
  height: 116px;
}
.cart_item .column_2 img{
  width: 175px;
  height: 115px;
  margin-right: 35px;
  vertical-align: middle;
}
.cart_item .column_3{
  width: 197px;
  position: relative;
  padding-left: 10px;
}
.my_el_select{
  width: 117px;
  height: 28px;
  position: absolute;
  top: 0;
  bottom: 0;
  margin: auto;
}
.cart_item .column_4{
  padding: 67px 10px;
  height: 116px;
  width: 142px;
  line-height: 116px;
}

</style>

```



服务端提供切换有效期选项的接口，视图：

```python
def change_course_expire(self,request):
    """更新用户购物车的商品有效期选项"""
    # 获取客户端的信息[course_id, user_id ,expire_time]
    user_id = request.user.id
    course_id = request.data.get("course_id")
    expire_time = request.data.get("expire_time")

    # 连接redis，修改购物车中商品的有效期选项
    redis_conn = get_redis_connection("cart")
    redis_conn.hset("cart_%s" % user_id, course_id, expire_time)
    return Response({"message": "切换商品有效期选项成功！"})
```

cart/views.py

```python
# Create your views here.
from rest_framework.viewsets import ViewSet
from django_redis import get_redis_connection
from rest_framework.response import Response
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
from course.models import Course
from luffyapi.settings import constants

class CartViewSet(ViewSet):
    permission_classes = [IsAuthenticated]
    def post(self,request):
        """添加商品课程到购物车中"""
        """接收客户端提交的数据"""
        user_id = request.user.id
        course_id=request.data.get("course_id")   #对数据进行验证
        expire_time = 0
        # 打开redis连接
        redis_conn = get_redis_connection("cart")

        # 把商品信息保存到redis中
        redis_conn = get_redis_connection("cart")
        pipe = redis_conn.pipeline()
        pipe.multi()
        pipe.hset("cart_%s" % user_id, course_id, expire_time)
        pipe.sadd("selected_%s" % user_id, course_id) # 默认用户添加商品到购物车时就是默认选中
        pipe.execute()

        cart_num = redis_conn.hlen("cart_%s" % user_id)

        # 返回数据给客户端
        return Response({"cart_num":cart_num},status=status.HTTP_201_CREATED)

    def get(self,request):
        """购物车商品列表"""
        # 1.获取当前用户的id
        user_id = request.user.id

        # 2.在redis中获取当前用户的购物车商品信息
        redis_conn = get_redis_connection("cart")

        cart_hash = redis_conn.hgetall("cart_%s" % user_id)
        selected_set = redis_conn.smembers("selected_%s" % user_id)

        # 要返回给客户端的数据
        data = []

        # 3.在mysql中根据购物车的商品id获取商品其他详细信息
        for course_id_bytes, expire_time_bytes in cart_hash.items():
            course_id = course_id_bytes.decode()
            expire_time = int( expire_time_bytes.decode() )
            try:
                course = Course.objects.get(pk=course_id)
                data.append({
                    "course_id": course.id,
                    "course_img": constants.SERVER_IMAGE_URL + course.course_img.url, # 返回图片的url地址
                    "course_name": course.name,
                    "price": course.price,
                    "selected": True if course_id_bytes in selected_set else False,
                    "expire_list": course.get_expire_list, # 当前商品课程所有的有效期选项列表
                    "expire": expire_time, # 购物车中当前商品的勾选有效期
                })
            except Course.DoesNotExist:
                pass

        # 4.返回数据给客户端
        return Response(data)

    def change_course_status(self,request):
        """更新用户购物车的商品勾选状态"""
        # 获取客户端的信息
        user_id = request.user.id
        course_id = request.data.get("course_id")
        selected = request.data.get("selected")

        # 连接redis，修改购物车中商品的勾选状态
        redis_conn = get_redis_connection("cart")
        if selected:
            """添加勾选状态"""
            redis_conn.sadd("selected_%s" % user_id, course_id)
        else:
            """取消勾选状态"""
            redis_conn.srem("selected_%s" % user_id, course_id)

        return Response({"message":"切换商品勾选状态成功！"})

    def change_course_expire(self,request):
        """更新用户购物车的商品有效期选项"""
        # 获取客户端的信息[course_id, user_id ,expire_time]
        user_id = request.user.id
        course_id = request.data.get("course_id")
        expire_time = request.data.get("expire_time")

        # 连接redis，修改购物车中商品的有效期选项
        redis_conn = get_redis_connection("cart")
        redis_conn.hset("cart_%s" % user_id, course_id, expire_time)
        return Response({"message": "切换商品有效期选项成功！"})

    def delete(self,request):
        pass


```

course/urls.py，路由代码：

```python
from django.urls import path,re_path
from . import views
urlpatterns = [
    path("", views.CartViewSet.as_view({"post":"post","get":"get","put":"change_course_status","patch":"change_course_expire"})),
]
```

客户端中，实现ajax请求，CartItem.vue，代码：

```JS
change_course_expire(){
    // 切换商品的有效期选项
    for(let item of this.course.expire_list ){
        if(item.expire_time === this.course.expire){
            this.course.price = item.price;
            // 同步到服务端
            this.$axios.patch(`${this.$settings.Host}/cart/`,{
                course_id: this.course.course_id,
                expire_time: item.expire_time,
            },{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
                this.$message.success("切换有效期选项成功！");
            }).catch(error=>{
                this.$message.error("切换有效期选项失败！");
            });
        }
    }
}
```

```vue
<template>
    <div class="cart_item">
      <div class="cart_column column_1">
        <el-checkbox class="my_el_checkbox" v-model="course.selected"></el-checkbox>
      </div>
      <div class="cart_column column_2">
        <img :src="course.course_img" alt="">
        <span><router-link :to="`/course/${course.course_id}`">{{course.course_name}}</router-link></span>
      </div>
      <div class="cart_column column_3">
        <el-select v-model="course.expire" size="mini" placeholder="请选择购买有效期" class="my_el_select">
          <el-option v-for="item in course.expire_list" :label="item.expire_text" :value="item.expire_time" :key="item.expire_time"></el-option>
        </el-select>
      </div>
      <div class="cart_column column_4">¥{{course.price.toFixed(2)}}</div>
      <div class="cart_column column_4">删除</div>
    </div>
</template>

<script>
export default {
    name: "CartItem",
    props:["course","token"],
    data(){
      return {
        checked:false
      }
    },
    watch:{
        "course.selected": function(){
            // 当用户切换商品勾选状态时，同步到服务端
            this.change_course_status();
        },
        "course.expire": function(){
            // 当用户切换商品有效期时，切换对应选项的价格显示在页面中,并同步到服务端
            this.change_course_expire();
        }
    },
    methods:{
        change_course_status(){
            // 切换商品的勾选状态
            this.$axios.put(`${this.$settings.Host}/cart/`,{
                course_id: this.course.course_id,
                selected: this.course.selected,
            },{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
                this.$message.success("切换勾选状态成功！");
            }).catch(error=>{
                this.$message.error("切换勾选状态失败！");
            });
        },
        change_course_expire(){
            // 切换商品的有效期选项
            for(let item of this.course.expire_list ){
               if(item.expire_time === this.course.expire){
                  this.course.price = item.price;
                  // 同步到服务端
                  this.$axios.patch(`${this.$settings.Host}/cart/`,{
                      course_id: this.course.course_id,
                      expire_time: item.expire_time,
                  },{
                      headers:{
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response=>{
                      this.$message.success("切换有效期选项成功！");
                  }).catch(error=>{
                      this.$message.error("切换有效期选项失败！");
                  });
               }
            }
        }
    }
}
</script>

<style scoped>
.cart_item::after{
  content: "";
  display: block;
  clear: both;
}
.cart_column{
  float: left;
  height: 250px;
}
.cart_item .column_1{
  width: 88px;
  position: relative;
}
.my_el_checkbox{
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 0;
  margin: auto;
  width: 16px;
  height: 16px;
}
.cart_item .column_2 {
  padding: 67px 10px;
  width: 520px;
  height: 116px;
}
.cart_item .column_2 img{
  width: 175px;
  height: 115px;
  margin-right: 35px;
  vertical-align: middle;
}
.cart_item .column_3{
  width: 197px;
  position: relative;
  padding-left: 10px;
}
.my_el_select{
  width: 117px;
  height: 28px;
  position: absolute;
  top: 0;
  bottom: 0;
  margin: auto;
}
.cart_item .column_4{
  padding: 67px 10px;
  height: 116px;
  width: 142px;
  line-height: 116px;
}

</style>

```



因为我们之前在购物车中商品列表的商品使用的字段是price，所以在永久有效选项的情况下，价格是正确的。

但是如果我们有其他的有效期选项时，在切换有效期后，则价格显示有问题！

所以我们接下来需要调整在切换有效期时的代码逻辑.让程序以指定的有效期价格重新使用当前有效期选项的价格进行优惠计算！！

模型代码：

```python
class Course(BaseModel):
    """
    实战课程
    """

    # .....省略

    def real_price(self,expire_time):
        """根据有效期选项获取真实价格"""
        price = self.price
        # 如果购物车中的有效期选项非0,则表示有其他的有效期选项,则提取对应选项的价格
        if expire_time > 0:
            courseexpire = self.course_expire.get(expire_time=expire_time)
            price = courseexpire.price

        return price
```



视图调用模型中的real_price时，通过传递expire_time，来计算真实价格到购物车商品列表中.

```js
"price": course.real_price(expire_time),
```

```python
    def get(self,request):
        """购物车商品列表"""
        # 1.获取当前用户的id
        user_id = request.user.id

        # 2.在redis中获取当前用户的购物车商品信息
        redis_conn = get_redis_connection("cart")

        cart_hash = redis_conn.hgetall("cart_%s" % user_id)
        selected_set = redis_conn.smembers("selected_%s" % user_id)

        # 要返回给客户端的数据
        data = []

        # 3.在mysql中根据购物车的商品id获取商品其他详细信息
        for course_id_bytes, expire_time_bytes in cart_hash.items():
            course_id = course_id_bytes.decode()
            expire_time = int( expire_time_bytes.decode() )

            try:
                course = Course.objects.get(pk=course_id)
                data.append({
                    "course_id": course.id,
                    "course_img": constants.SERVER_IMAGE_URL + course.course_img.url, # 返回图片的url地址
                    "course_name": course.name,
                    "price": course.real_price(expire_time),
                    "selected": True if course_id_bytes in selected_set else False,
                    "expire_list": course.get_expire_list, # 当前商品课程所有的有效期选项列表
                    "expire": expire_time, # 购物车中当前商品的勾选有效期
                })
            except Course.DoesNotExist:
                pass

        # 4.返回数据给客户端
        return Response(data)
```



## 购物车商品的删除操作

后端实现根据商品课程ID,删除redis中的商品课程接口.

cart/views.py，代码：

```python
    def delete(self,request):
        """购物车商品的删除操作"""
        # 1. 获取客户端的信息[course_id, user_id]
        user_id = request.user.id
        course_id = request.query_params.get("course_id")
        # 2. 连接redis，执行删除操作
        redis_conn = get_redis_connection("cart")

        pipe = redis_conn.pipeline()
        pipe.multi()
        pipe.hdel("cart_%s" % user_id, course_id)
        pipe.srem("selected_%s" % user_id, course_id)
        pipe.execute()

        # 3. return
        return Response({"message":"delete success!"},status=status.HTTP_204_NO_CONTENT)
```

cart/urls.py,代码:

```python
from django.urls import path,re_path
from . import views
urlpatterns = [
    path("", views.CartViewSet.as_view({
        "post":"post",
        "get":"get",
        "put":"change_course_status",
        "patch":"change_course_expire",
        "delete":"delete"
    })),
]
```

客户端发送ajax删除商品信息

```html
<div class="cart_column column_4 delete" @click="deleteHandler">删除</div>
```

```js
        deleteHandler(){
            // 购物车商品的删除操作
            this.$axios.delete(`${this.$settings.Host}/cart/`,{
                params:{
                    course_id: this.course.course_id,
                },
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
                this.$message.success("删除商品操作成功!~");
            }).catch(error=>{
                this.$message.error("删除商品操作失败!~");
            })
        }
```

CartItem.vue

```vue
<template>
    <div class="cart_item">
      <div class="cart_column column_1">
        <el-checkbox class="my_el_checkbox" v-model="course.selected"></el-checkbox>
      </div>
      <div class="cart_column column_2">
        <img :src="course.course_img" alt="">
        <span><router-link :to="`/course/${course.course_id}`">{{course.course_name}}</router-link></span>
      </div>
      <div class="cart_column column_3">
        <el-select v-model="course.expire" size="mini" placeholder="请选择购买有效期" class="my_el_select">
          <el-option v-for="item in course.expire_list" :label="item.expire_text" :value="item.expire_time" :key="item.expire_time"></el-option>
        </el-select>
      </div>
      <div class="cart_column column_4">¥{{course.price.toFixed(2)}}</div>
      <div class="cart_column column_4 delete" @click="deleteHandler">删除</div>
    </div>
</template>

<script>
export default {
    name: "CartItem",
    props:["course","token"],
    data(){
      return {
        checked:false
      }
    },
    watch:{
        "course.selected": function(){
            // 当用户切换商品勾选状态时，同步到服务端
            this.change_course_status();
        },
        "course.expire": function(){
            // 当用户切换商品有效期时，切换对应选项的价格显示在页面中,并同步到服务端
            this.change_course_expire();
        }
    },
    methods:{
        change_course_status(){
            // 切换商品的勾选状态
            this.$axios.put(`${this.$settings.Host}/cart/`,{
                course_id: this.course.course_id,
                selected: this.course.selected,
            },{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
                this.$message.success("切换勾选状态成功！");
            }).catch(error=>{
                this.$message.error("切换勾选状态失败！");
            });
        },
        change_course_expire(){
            // 切换商品的有效期选项
            for(let item of this.course.expire_list ){
               if(item.expire_time === this.course.expire){
                  this.course.price = item.price;
                  // 同步到服务端
                  this.$axios.patch(`${this.$settings.Host}/cart/`,{
                      course_id: this.course.course_id,
                      expire_time: item.expire_time,
                  },{
                      headers:{
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response=>{
                      this.$message.success("切换有效期选项成功！");
                  }).catch(error=>{
                      this.$message.error("切换有效期选项失败！");
                  });
               }
            }
        },
        deleteHandler(){
            // 购物车商品的删除操作
            this.$axios.delete(`${this.$settings.Host}/cart/`,{
                params:{
                    course_id: this.course.course_id,
                },
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
                this.$message.success("删除商品操作成功!~");
            }).catch(error=>{
                this.$message.error("删除商品操作失败!~");
            })
        }
    }
}
</script>

<style scoped>
.cart_item::after{
  content: "";
  display: block;
  clear: both;
}
.cart_column{
  float: left;
  height: 250px;
}
.cart_item .column_1{
  width: 88px;
  position: relative;
}
.my_el_checkbox{
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 0;
  margin: auto;
  width: 16px;
  height: 16px;
}
.cart_item .column_2 {
  padding: 67px 10px;
  width: 520px;
  height: 116px;
}
.cart_item .column_2 img{
  width: 175px;
  height: 115px;
  margin-right: 35px;
  vertical-align: middle;
}
.cart_item .column_3{
  width: 197px;
  position: relative;
  padding-left: 10px;
}
.my_el_select{
  width: 117px;
  height: 28px;
  position: absolute;
  top: 0;
  bottom: 0;
  margin: auto;
}
.cart_item .column_4{
  padding: 67px 10px;
  height: 116px;
  width: 142px;
  line-height: 116px;
}
.delete{
  cursor: pointer;
}
.delete:hover{
  color: #aa0000;
}
</style>

```

虽然上面已经删除了保存在redis中购物车商品,但是客户端这边,还有对应的内容存在,所以我们在用户点击"删除"的时候,页面中也要发生变化,我们需要在当前子组件中,通过子组件传送数据给父组件.

子组件通过`this.$emit`来传递参数给父组件，调用上面删除商品的方法,

```js
.then(response=>{
                this.$message.success("删除商品操作成功!~");
                this.$emit("deleteHandler", this.course);
            }).catch(error=>{
```

CartItem.vue,代码;

```vue
<template>
    <div class="cart_item">
      <div class="cart_column column_1">
        <el-checkbox class="my_el_checkbox" v-model="course.selected"></el-checkbox>
      </div>
      <div class="cart_column column_2">
        <img :src="course.course_img" alt="">
        <span><router-link :to="`/course/${course.course_id}`">{{course.course_name}}</router-link></span>
      </div>
      <div class="cart_column column_3">
        <el-select v-model="course.expire" size="mini" placeholder="请选择购买有效期" class="my_el_select">
          <el-option v-for="item in course.expire_list" :label="item.expire_text" :value="item.expire_time" :key="item.expire_time"></el-option>
        </el-select>
      </div>
      <div class="cart_column column_4">¥{{course.price.toFixed(2)}}</div>
      <div class="cart_column column_4 delete" @click="deleteHandler">删除</div>
    </div>
</template>

<script>
export default {
    name: "CartItem",
    props:["course","token"],
    data(){
      return {
        checked:false
      }
    },
    watch:{
        "course.selected": function(){
            // 当用户切换商品勾选状态时，同步到服务端
            this.change_course_status();
        },
        "course.expire": function(){
            // 当用户切换商品有效期时，切换对应选项的价格显示在页面中,并同步到服务端
            this.change_course_expire();
        }
    },
    methods:{
        change_course_status(){
            // 切换商品的勾选状态
            this.$axios.put(`${this.$settings.Host}/cart/`,{
                course_id: this.course.course_id,
                selected: this.course.selected,
            },{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
                this.$message.success("切换勾选状态成功！");
            }).catch(error=>{
                this.$message.error("切换勾选状态失败！");
            });
        },
        change_course_expire(){
            // 切换商品的有效期选项
            for(let item of this.course.expire_list ){
               if(item.expire_time === this.course.expire){
                  this.course.price = item.price;
                  // 同步到服务端
                  this.$axios.patch(`${this.$settings.Host}/cart/`,{
                      course_id: this.course.course_id,
                      expire_time: item.expire_time,
                  },{
                      headers:{
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response=>{
                      this.$message.success("切换有效期选项成功！");
                  }).catch(error=>{
                      this.$message.error("切换有效期选项失败！");
                  });
               }
            }
        },
        deleteHandler(){
            // 购物车商品的删除操作
            this.$axios.delete(`${this.$settings.Host}/cart/`,{
                params:{
                    course_id: this.course.course_id,
                },
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
                this.$message.success("删除商品操作成功!~");
                this.$emit("deleteHandler", this.course);
            }).catch(error=>{
                this.$message.error("删除商品操作失败!~");
            })
        }
    }
}
</script>

<style scoped>
.cart_item::after{
  content: "";
  display: block;
  clear: both;
}
.cart_column{
  float: left;
  height: 250px;
}
.cart_item .column_1{
  width: 88px;
  position: relative;
}
.my_el_checkbox{
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 0;
  margin: auto;
  width: 16px;
  height: 16px;
}
.cart_item .column_2 {
  padding: 67px 10px;
  width: 520px;
  height: 116px;
}
.cart_item .column_2 img{
  width: 175px;
  height: 115px;
  margin-right: 35px;
  vertical-align: middle;
}
.cart_item .column_3{
  width: 197px;
  position: relative;
  padding-left: 10px;
}
.my_el_select{
  width: 117px;
  height: 28px;
  position: absolute;
  top: 0;
  bottom: 0;
  margin: auto;
}
.cart_item .column_4{
  padding: 67px 10px;
  height: 116px;
  width: 142px;
  line-height: 116px;
}
.delete{
  cursor: pointer;
}
.delete:hover{
  color: #aa0000;
}
</style>
```



购物车父组件Cart.vue，添加定义删除商品的方法:

```html
<CartItem
          :token="token"
          :key="key"
          :course="course"
          v-for="course,key in course_list"
          @deleteHandler="delete_course"
></CartItem>
```

```js
      delete_course(course){
          // 删除商品
          for(let key in this.course_list){
            if(course === this.course_list[key]){
                // 数组.splice(key, length) # 从指定下标key位置删除length个成员
                this.course_list.splice(key,1);
            }
          }
      }
```

Cart.vue,代码:

```vue
<template>
    <div class="cart">
      <Header></Header>
      <div class="cart_info">
        <div class="cart_title">
          <span class="text">我的购物车</span>
          <span class="total">共4门课程</span>
        </div>
        <div class="cart_table">
          <div class="cart_head_row">
            <span class="doing_row"></span>
            <span class="course_row">课程</span>
            <span class="expire_row">有效期</span>
            <span class="price_row">单价</span>
            <span class="do_more">操作</span>
          </div>
          <div class="cart_course_list">
            <CartItem
              :token="token"
              :key="key"
              :course="course"
              v-for="course,key in course_list"
              @deleteHandler="delete_course"
            ></CartItem>
          </div>
          <div class="cart_footer_row">
            <span class="cart_select"><label> <el-checkbox v-model="checked"></el-checkbox><span>全选</span></label></span>
            <span class="cart_delete"><i class="el-icon-delete"></i> <span>删除</span></span>
            <span class="goto_pay">去结算</span>
            <span class="cart_total">总计：¥0.0</span>
          </div>
        </div>
      </div>
      <Footer></Footer>
    </div>
</template>

<script>
import Header from "./common/Header"
import Footer from "./common/Footer"
import CartItem from "./common/CartItem"
export default {
    name: "Cart",
    data(){
      return {
        course_list: [],
        checked: false,
      }
    },
    created(){
        this.check_user();
        this.get_course();
    },
    methods:{
      check_user(){
          this.token = this.$settings.check_user_login();
          if(!this.token){
              let self = this;
              this.$alert("对不起，您尚未登录!无法访问购物车！","路飞学城",{
                  callback(){
                      self.$router.push("/user/login");
                  }
              })
          }
      },
      get_course(){
          // 获取购物车中的商品列表
          this.$axios.get(`${this.$settings.Host}/cart/`,{
              headers:{
                  Authorization: "jwt " + this.token,
              }
          }).then(response=>{
              this.course_list = response.data;
          }).catch(error=>{
              this.$alert("对不起，获取购物车商品列表信息失败！","路飞学城");
          });
      },
      delete_course(course){
          // 删除商品
          for(let key in this.course_list){
            if(course === this.course_list[key]){
                // 数组.splice(key, length) # 从指定下标key位置删除length个成员
                this.course_list.splice(key,1);
            }
          }
      }
    },
    components:{
      Header,
      Footer,
      CartItem,
    }
}
</script>

<style scoped>
.cart_info{
  width: 1200px;
  margin: 0 auto 200px;
}
.cart_title{
  margin: 25px 0;
}
.cart_title .text{
  font-size: 18px;
  color: #666;
}
.cart_title .total{
  font-size: 12px;
  color: #d0d0d0;
}
.cart_table{
  width: 1170px;
}
.cart_table .cart_head_row{
  background: #F7F7F7;
  width: 100%;
  height: 80px;
  line-height: 80px;
  padding-right: 30px;
}
.cart_table .cart_head_row::after{
  content: "";
  display: block;
  clear: both;
}
.cart_table .cart_head_row .doing_row,
.cart_table .cart_head_row .course_row,
.cart_table .cart_head_row .expire_row,
.cart_table .cart_head_row .price_row,
.cart_table .cart_head_row .do_more{
  padding-left: 10px;
  height: 80px;
  float: left;
}
.cart_table .cart_head_row .doing_row{
  width: 78px;
}
.cart_table .cart_head_row .course_row{
  width: 530px;
}
.cart_table .cart_head_row .expire_row{
  width: 188px;
}
.cart_table .cart_head_row .price_row{
  width: 162px;
}
.cart_table .cart_head_row .do_more{
  width: 162px;
}

.cart_footer_row{
  padding-left: 30px;
  background: #F7F7F7;
  width: 100%;
  height: 80px;
  line-height: 80px;
}

.cart_footer_row .cart_select span{
  margin-left: 17px;
  font-size: 18px;
  color: #666;
}
.cart_footer_row .cart_delete{
  margin-left: 58px;
}
.cart_delete .el-icon-delete{
  font-size: 18px;
}

.cart_delete span{
  margin-left: 15px;
  cursor: pointer;
  font-size: 18px;
  color: #666;
}
.cart_total{
  float: right;
  margin-right: 62px;
  font-size: 18px;
  color: #666;
}
.goto_pay{
  float: right;
  width: 159px;
  height: 80px;
  outline: none;
  border: none;
  background: #ffc210;
  font-size: 18px;
  color: #fff;
  text-align: center;
  cursor: pointer;
}
</style>
```







## 商品的总价格

#### 统计整个购物车中，勾选所有商品的总价格

有了购物车中各个商品课程的真实价格以后，那么我们就统计会算整个购物车中，勾选所有商品的总价格了。

Cart.vue，代码：

```vue
<template>
    <div class="cart">
      <Header></Header>
      <div class="cart_info">
        <div class="cart_title">
          <span class="text">我的购物车</span>
          <span class="total">共{{$store.state.cart_length}}门课程</span>
        </div>
        <div class="cart_table">
          <div class="cart_head_row">
            <span class="doing_row"></span>
            <span class="course_row">课程</span>
            <span class="expire_row">有效期</span>
            <span class="price_row">单价</span>
            <span class="do_more">操作</span>
          </div>
          <!-- 购物车中商品列表 -->
          <div class="cart_course_list">
            <CartItem :key="key" v-for="(course,key) in course_list" :course="course"></CartItem>
          </div>
          <div class="cart_footer_row">
            <span class="cart_select"><label> <el-checkbox v-model="checked"></el-checkbox><span>全选</span></label></span>
            <span class="cart_delete"><i class="el-icon-delete"></i> <span>删除</span></span>
            <span class="goto_pay">去结算</span>
            <span class="cart_total">总计：¥{{total_price.toFixed(2)}}</span>
          </div>
        </div>
      </div>
      <Footer></Footer>
    </div>
</template>

<script>
import Header from "./common/Header"
import Footer from "./common/Footer"
import CartItem from "./common/CartItem"
export default {
    name: "Cart",
    data(){
      return {
        token: "",
        course_list: [],
        total_price: 0.00,
        checked: false,  // 全选的标志
      }
    },
    created(){
      this.token = this.check_user_login();
      this.get_cart();
    },
    methods:{
      calc_total(){
        // 计算购物车勾选商品的总价格
          /**
             // 在javascript中，数组有一个默认的方法，forEach可以用于对数组进行便利
             arr1 = ["a","b","c","d"]
             arr1.forEach(function(value,key){
                  console.log(`下标：${key}，值=${value}`);
             });
           */
        let total = 0;
        this.course_list.forEach((course,key)=>{
          if(course.selected){
            total += parseFloat( course.price );
          }
        });
        this.total_price = total;
      },
      get_cart(){
          // 获取购物车中的商品信息
          this.$axios.get(`${this.$settings.HOST}/cart/`,{
              headers:{
                  "Authorization": "jwt " + this.token,
              }
          }).then(response=>{
              this.course_list = response.data;
              this.$store.commit("add_cart", this.course_list.length);
              // 统计勾选商品课程的真实价格
              this.calc_total();
          }).catch(error=>{
              console.log(error.response);
          })
      },
      check_user_login(){
        let token = localStorage.user_token || sessionStorage.user_token;
        if( !token ){
            let self = this;
            this.$confirm("对不起，您尚未登录！所以请登录再使用购物车","路飞学城",{
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                type: 'warning'
            }).then(() => {
                self.$router.push("/user/login");
            });
            return false; // 阻止js继续往下执行
        }
        return token;
      },
    },
    components:{
      Header,
      Footer,
      CartItem,
    }
}
</script>

<style scoped>
.cart_info{
  width: 1200px;
  margin: 0 auto 200px;
}
.cart_title{
  margin: 25px 0;
}
.cart_title .text{
  font-size: 18px;
  color: #666;
}
.cart_title .total{
  font-size: 12px;
  color: #d0d0d0;
}
.cart_table{
  width: 1170px;
}
.cart_table .cart_head_row{
  background: #F7F7F7;
  width: 100%;
  height: 80px;
  line-height: 80px;
  padding-right: 30px;
}
.cart_table .cart_head_row::after{
  content: "";
  display: block;
  clear: both;
}
.cart_table .cart_head_row .doing_row,
.cart_table .cart_head_row .course_row,
.cart_table .cart_head_row .expire_row,
.cart_table .cart_head_row .price_row,
.cart_table .cart_head_row .do_more{
  padding-left: 10px;
  height: 80px;
  float: left;
}
.cart_table .cart_head_row .doing_row{
  width: 78px;
}
.cart_table .cart_head_row .course_row{
  width: 530px;
}
.cart_table .cart_head_row .expire_row{
  width: 188px;
}
.cart_table .cart_head_row .price_row{
  width: 162px;
}
.cart_table .cart_head_row .do_more{
  width: 162px;
}

.cart_footer_row{
  padding-left: 30px;
  background: #F7F7F7;
  width: 100%;
  height: 80px;
  line-height: 80px;
}
.cart_footer_row .cart_select span{
  margin-left: 7px;
  font-size: 18px;
  color: #666;
}
.cart_footer_row .cart_delete{
  margin-left: 58px;
}
.cart_delete .el-icon-delete{
  font-size: 18px;
}

.cart_delete span{
  margin-left: 15px;
  cursor: pointer;
  font-size: 18px;
  color: #666;
}
.cart_total{
  float: right;
  margin-right: 62px;
  font-size: 18px;
  color: #666;
}
.goto_pay{
  float: right;
  width: 159px;
  height: 80px;
  outline: none;
  border: none;
  background: #ffc210;
  font-size: 18px;
  color: #fff;
  text-align: center;
  cursor: pointer;
}
</style>

```

#### 切换课程勾选状态或有效期选项时，重新计算总价

在父组件中调用子组件时，声明调用统计总价的方法。

```vue
<CartItem :key="key" v-for="(course,key) in course_list" @change_select="calc_total" :course="course"></CartItem>
```

在子组件中，当用户切换勾选状态和切换有效期时，通过`this.$emit()`通知父组件调用`calc_total`方法

```vue
<template>
    <div class="cart_item">
      <div class="cart_column column_1">
        <el-checkbox class="my_el_checkbox" v-model="course.selected"></el-checkbox>
      </div>
      <div class="cart_column column_2">
        <img :src="course.course_img" alt="">
        <span><router-link :to="'/courses/detail/'+course.id">{{course.name}}</router-link></span>
      </div>
      <div class="cart_column column_3">
        <el-select v-model="course.expire_id" size="mini" placeholder="请选择购买有效期" class="my_el_select">
          <el-option v-for="item in course.expire_list" :label="item.expire_text" :value="item.id" :key="item.id"></el-option>
        </el-select>
      </div>
      <div class="cart_column column_4">¥{{course.price}}</div>
      <div class="cart_column column_4">删除</div>
    </div>
</template>

<script>
export default {
    name: "CartItem",
    props:["course"],
    data(){
      return {
        expire: "1个月有效",
      }
    },
    watch:{
        "course.selected": function(){
            this.change_selected();
        },
        "course.expire_id": function(){
            this.change_expire();
        }
    },
    methods:{
        change_expire(){
            // 切换有效期
            let token = localStorage.user_token || sessionStorage.user_token;
            this.$axios.put(`${this.$settings.HOST}/cart/`,{
                expire_id: this.course.expire_id,
                course_id: this.course.id
            },{
                headers:{
                    "Authorization": "jwt " + token,
                }
            }).then(response=>{
                this.$message.success(response.data.message);
                this.course.price = response.data.real_price;
                // 当子组件中，切换了商品课程的有效期选项，则通知父组件重新计算购物商品总价
                this.$emit("change_select");
            }).catch(error=>{
                this.$message.error(error.response);
            })
        },
        change_selected(){
            let token = localStorage.user_token || sessionStorage.user_token;
            // 切换商品课程的勾选状态
            this.$axios.patch(`${this.$settings.HOST}/cart/`,{
                selected: this.course.selected,
                course_id: this.course.id
            },{
                headers:{
                    "Authorization": "jwt " + token,
                }
            }).then(response=>{
                this.$message.success(response.data.message);
                // 当子组件中，切换了商品课程的勾选状态，则通知父组件重新计算购物商品总价
                this.$emit("change_select");

            }).catch(error=>{
                this.$message.error(error.response);
            })
        }
    }
}
</script>
```






