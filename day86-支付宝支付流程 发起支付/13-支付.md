# 发起支付

在前端Order.vue实现可以让用户选择对应的支付方式

```vue
        <div class="calc">
            <el-row class="pay-row">
              <el-col :span="4" class="pay-col"><span class="pay-text">支付方式：</span></el-col>
              <el-col :span="8">
                <span class="alipay" v-if="pay_type==0"><img src="../../static/image/alipay2.png" alt=""></span>
                <span class="alipay" @click="pay_type=0" v-else><img src="../../static/image/alipay.png" alt=""></span>
                <span class="alipay wechat" v-if="pay_type==1"><img src="../../static/image/wechat2.png" alt=""></span>
                <span class="alipay wechat" @click="pay_type=1" v-else><img src="../../static/image/wechat.png" alt=""></span>
              </el-col>
              <el-col :span="8" class="count">实付款： <span>¥{{(real_total - credit / credit_to_money ).toFixed(2)}}</span></el-col>
              <el-col :span="4" class="cart-pay"><span @click="payHander">立即支付</span></el-col>
            </el-row>
        </div>
```



## 支付宝

目前流行的第三方支付平台:

```
国内
    支付宝, 微信, 京东支付, 百度钱包, ApplePay, 贝宝

国外
	paypal(贝宝), 信用卡支付, 西联支付, 
```

银联支付-> 实现大额支付



### 支付宝开发平台登录

支付宝开发平台: https://open.alipay.com/platform/home.htm

![1554189376336](assets/1554189376336.png)

![1554189403316](assets/1554189403316.png)



![1554189677144](assets/1554189677144.png)



为当前网站创建一个应用,并在应用中添加对应环境的支付功能.

但是支付功能的开通需要和蚂蚁金服进行签约.

签约地址: https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001000



### 沙箱环境

- 是支付宝提供给开发者的模拟支付的环境

- 沙箱环境跟真实环境是分开的，项目上线时必须切换对应的配置服务器地址和开发者ID和密钥。

- **沙箱应用开发文档**：https://docs.open.alipay.com

- **沙箱账号**：<https://openhome.alipay.com/platform/appDaily.htm?tab=account>

- 开发者中心-->研发服务-->沙箱

  ![进入沙箱环境.png](assets/%E8%BF%9B%E5%85%A5%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83.png)

```
真实的支付宝网关:   https://openapi.alipay.com/gateway.do
	
沙箱的支付宝网关:   https://openapi.alipaydev.com/gateway.do
```



### 支付宝开发者文档

- **文档主页**：[https://openhome.alipay.com/developmentDocument.htm](https://openhome.alipay.com/developmentDocument.htm)
- **产品介绍**：<https://docs.open.alipay.com/270>

### 电脑网站支付流程

时序图[ 时间顺序流程图 ]

![电脑网站支付流程图](assets/%E7%94%B5%E8%84%91%E7%BD%91%E7%AB%99%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B%E5%9B%BE1.png)

![1566548142736](assets/1566548142736.png)



### 开发支付功能

```
cd luffyapi/apps
python ../../manage.py startapp payments
```

注册子应用

```python
INSTALLED_APPS = [
	。。。。
    'payments',
]
```



### 配置秘钥

#### 1. 生成应用的私钥和公钥

下载对应系统的秘钥生成工具:  https://doc.open.alipay.com/docs/doc.htm?treeId=291&articleId=105971&docType=1

#### windows操作系统

生成如下,安装软件时需要管理员身份来安装.

![1566548916758](assets/1566548916758.png)

#### Linux系统

生成命令如下,根据提示先进入openssl终端, 如下操作:

```bash
openssl
OpenSSL> genrsa -out app_private_key.pem 2048                         # 生成私钥到指定文件中
OpenSSL> rsa -in app_private_key.pem -pubout -out app_public_key.pem  # 导出公钥
OpenSSL> exit
```

![1575971951882](assets/1575971951882.png)

应用公钥复制粘贴到支付宝网站页面中.

![1575971997353](assets/1575971997353.png)

点击修改以后,粘贴进去

![1554192143494](assets/1554192143494.png)

应用秘钥 app_private_key.pem

```
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA0XMYzmnmezFM0VkiY1sxIzzqr7cUtisNU4z5c6Wu+96AcvKM
Hb79ZxoD/gotAYHayWRC6/gj846J/mkC1TerdjxdjFBOW8/T2LwgOvkZKlPuYlXU
RMfGq6aCRF7mo8AZHdArpQuAPmNO89pZ2LdRXn8v0rCWczA13kGp6WjF7FxpHafO
rmi15TZsNL1KVene0ZRsrKQeOFKQ1jgn55skpUDxPE4cEsX3iwI3AC32xNiCrKIS
MeWZkDaXf2M49DG21gPOOTekiFQ4QsCtMgQWiSaICZ7HSTcOa5S47Ia/WKdyFDTa
abw4AZhLNfWWGpq6p8uxLFh0Gg5YMe8ANmR73wIDAQABAoIBAC4Z0Fb2lkV9V3Qo
01ndI5am/N0KRiPGnBtMx0c+K6LCmbEzU8XkWPBNmJ1c7gUL6PU0/UnlBzy/nf4C
bR4zL6lJpimRL34j43QsDEgOtgxMBwdb7unoswDrGHcmEEvwp1aZkFG2k1aoEyO3
Ztk9mEpdYlBUj/jwnpq6B0UZy563Xm52X6C30qZIGkHtodZDpKW6QuwWDJvb7Gsa
Ad8UdZ8gtIjPSghHPyMCnSzk0bvYm9VwWr7ckJY6oA5Gyd2PL1GwWiaNZKaG2nFU
m0oEyElJuz/CIFkdYGpGV89VvQwOXRb+Qq3ve7RG8F7TD8fsJf966tSS0CDx/lCW
YjV+rGkCgYEA7fVu8Gbq6uASakLMvbo4PcKDKRbSR+Kl2vscEiV0BBeWxUSu5dYr
Ajh5hXe4uC88kjaSU3kdN5aXPPj0G+jumxYJXkIHsFGUIXQjFsMDVjSlnGVgQmUj
kp7bYTLBvxVT+ZA8HwAN7OE++D1QDLoOPG3/gd6D3MVxaNlj67f3byMCgYEA4VRT
qiMVmBWdPsyDZE6A9/EBdSoB4joNCTaES7Cc60jIb7LETkqjYXfFglEtIJ2f65kA
f0E70ZtvgLNauDwsAQZ1El6pBSnkgaP8imhmWOZG4NxIUERSormY2LLWpwjuZjG+
YsfunWfSgbQHeK1ymgYsVRQfpfne4Mh2BJzLChUCgYAoLB8mhrlyHZH+TniyLxX/
ly79aNTnPeQyK+J5TclgR3s0onvEYXuxTEd3uNZ+gbsAFCZv4SqFj+7IZF8RtylR
FU9PkmYp5hvT6f9igFm32/t5g8PUca6nuhnfNupuj/M1VpxPv3qaWwx+bBtvipmM
qiVQj3hDdTHIOascyFoFcQKBgG5RcNy9bJcXDfNvAW0cmjvJvOL1/BIcRcGa9U5x
W4I+EhPNvBpwpGjV0NcqkyOCyIb6U6n58CWBKigip2nH2+tsk+i4e5vRlNR7yuqg
jms74ru4XZcevC57G4AMntcMoltaQ1HtfL+H0yI5V+cXVCJgn1fQEGacXShEPLOp
aCa5AoGBANcDo4FfXFSiZUiYPW2bwPaZTjMj95LieNEAW6cnGX9hOixaQYdBhcGg
k+btBWxFbmes4JoGfyhv8M9P/mOiPS34Ndkox83YOwYOAeI7U3uzDIZDIT0BBC50
SNWwfn5NkcugIt2O2uKuSR9wqITljCJZRJi6Du8xXbNRiMOjU+hq
-----END RSA PRIVATE KEY-----
```

应用公钥 app_public_key.pem

```RSA
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0XMYzmnmezFM0VkiY1sxIzzqr7cUtisNU4z5c6Wu+96AcvKMHb79ZxoD/gotAYHayWRC6/gj846J/mkC1TerdjxdjFBOW8/T2LwgOvkZKlPuYlXURMfGq6aCRF7mo8AZHdArpQuAPmNO89pZ2LdRXn8v0rCWczA13kGp6WjF7FxpHafOrmi15TZsNL1KVene0ZRsrKQeOFKQ1jgn55skpUDxPE4cEsX3iwI3AC32xNiCrKISMeWZkDaXf2M49DG21gPOOTekiFQ4QsCtMgQWiSaICZ7HSTcOa5S47Ia/WKdyFDTaabw4AZhLNfWWGpq6p8uxLFh0Gg5YMe8ANmR73wIDAQAB
```

支付宝公钥 alipay_public_key.pem

```RSA
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqtdjdvDz/CwQBUFXagAJI9IsL2V4NLfliWe0e2l37L39WRJO8/nrwjn5UFeNgJmVJk5fkVFsh3IxsFHz7ddO3e5QBCVs+6SPX6oyx/OC9rrkQCUoy36ovV5FbDRRWYESxfU3ym/7dI6kIUaBOjDadEP9guL5abk6JSf62/mKR3MkXPUaSLWcuTsuccZ6KGvKsBpbKW3tPOEPCnTtbfUCdjg2m84H8joAh529uwcSsNDUcy5cL6O1/nsxazg8VXlKIU8DnOG1m8Peycw8/scXbJTeHLrHUPXM+2NeTKNLA7K7aBqe0uTR2AFDRlM/dX6V3ldPOaOIt5AZ19MyziCNJwIDAQAB
```



#### 2. 保存应用私钥文件

在payments应用中新建keys目录，用来保存秘钥文件。

将应用私钥文件app_private_key.pem复制到payment/keys目录下。

windows系统生成的私钥必须在上下两行加上以下标识:

```
-----BEGIN RSA PRIVATE KEY-----
私钥
-----END RSA PRIVATE KEY-----
```



#### 3. 保存支付宝公钥到项目中

在payments/key目录下新建alipay_public_key.pem文件，用于保存支付宝的公钥文件。

将支付宝的公钥内容复制到alipay_public_key.pem文件中

![支付宝公钥](assets/%E6%94%AF%E4%BB%98%E5%AE%9D%E5%85%AC%E9%92%A5.png)

```
-----BEGIN PUBLIC KEY-----
支付宝公钥
-----END PUBLIC KEY-----
```

![1554200221417](assets/1554200221417.png)



#### 4. 使用支付宝的sdk开发支付接口

SDK：https://docs.open.alipay.com/270/106291/

python版本的支付宝SDK文档：[https://github.com/fzlee/alipay/blob/master/README.zh-hans.md](https://github.com/fzlee/alipay/blob/master/README.zh-hans.md)

安装命令：

```
pip install python-alipay-sdk --upgrade
```



### 后端提供发起支付的接口url地址

payments/views.py,代码:

```python
# Create your views here.
from rest_framework.views import APIView
from alipay import AliPay
from django.conf import settings
from order.models import Order
from rest_framework.response import Response
from rest_framework import status
class AlipayAPIView(APIView):
    def get(self,request):
        """根据订单号生成一个支付宝的链接地址"""
        order_number = request.query_params.get("order_number")
        try:
            order = Order.objects.get(order_number=order_number)
        except Order.DoesNotExist:
            return Response({"message":"当前订单号无效！发起支付失败！"}, status=status.HTTP_400_BAD_REQUEST)

        with open(settings.ALIPAY_CONFIG["app_private_key_path"],"r") as f:
            app_private_key_string = f.read()

        with open(settings.ALIPAY_CONFIG["alipay_public_key_path"], "r") as f:
            alipay_public_key_string = f.read()

        alipay = AliPay(
            appid= settings.ALIPAY_CONFIG["appid"],  # 应用ID
            app_notify_url=settings.ALIPAY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_string=app_private_key_string,
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_string=alipay_public_key_string,
            sign_type=settings.ALIPAY_CONFIG["sign_type"],  # RSA 或者 RSA2
            debug = settings.ALIPAY_CONFIG["debug"]  # 默认False
        )

        # 电脑网站支付，需要跳转到https://openapi.alipay.com/gateway.do? + order_string
        order_string = alipay.api_alipay_trade_page_pay(
            out_trade_no=order.order_number, # 订单号
            total_amount=float(order.real_price),       # 订单价格
            subject=order.order_title,         # 订单标题
            return_url=settings.ALIPAY_CONFIG["return_url"],  # 同步结果回调地址
            notify_url=settings.ALIPAY_CONFIG["notify_url"]  # 异步结果回调地址
        )

        url = settings.ALIPAY_CONFIG["gateway_url"] + order_string

        return Response({"url": url})
```



#### 在配置文件中编辑支付宝的配置信息[实际的值根据自己的账号而定]

setttings/dev.py,代码:

```python
# 支付宝配置信息
ALIPAY_CONFIG = {
    # "gateway_url": "https://openapi.alipay.com/gateway.do?", # 真实支付宝网关地址
    "gateway_url": "https://openapi.alipaydev.com/gateway.do?", # 沙箱支付宝网关地址
    "appid": "2016101400686802",
    "app_notify_url": None,
    "app_private_key_path": os.path.join(BASE_DIR, "apps/payments/keys/app_private_key.pem"),
    "alipay_public_key_path": os.path.join(BASE_DIR, "apps/payments/keys/alipay_public_key.pem"),
    "sign_type": "RSA",
    "debug": False,
    "return_url": "http://www.luffycity.cn:8080/payments/alipay/result", # 同步回调地址
    "notify_url": "http://api.luffycity.cn:8000/payments/alipay/result", # 异步结果通知
}
```

注册url地址:payments/urls.py,代码:

```python
from django.urls import path,re_path
from . import views
urlpatterns = [
    path("alipay/",views.AlipayAPIView.as_view()),
]
```

总路由,代码:

```python
    path('payments/', include('payments.urls')),
```



#### 前端点击"支付宝支付",会生成订单,生成订单返回订单号以后,再次请求后端的获取支付api的url地址

```vue
<template>
  <div class="cart">
    <Header/>
    <div class="cart-info">
        <h3 class="cart-top">购物车结算 <span>共1门课程</span></h3>
        <div class="cart-title">
           <el-row>
             <el-col :span="2">&nbsp;</el-col>
             <el-col :span="10">课程</el-col>
             <el-col :span="8">有效期</el-col>
             <el-col :span="4">价格</el-col>
           </el-row>
        </div>
        <div class="cart-item" v-for="course in course_list">
          <el-row>
             <el-col :span="2" class="checkbox">&nbsp;&nbsp;</el-col>
             <el-col :span="10" class="course-info">
               <img :src="course.course_img" alt="">
               <div class="course_text">
                 <span>{{course.course_name}}</span>
                 <span class="discount_name">{{course.discount_name}}</span>
               </div>
             </el-col>
             <el-col :span="8"><span>{{course.expire_text}}</span></el-col>
             <el-col :span="4" class="course-price">
               <p>¥{{course.real_price.toFixed(2)}}</p>
               <p class="original_price">原价： ¥{{course.price.toFixed(2)}}</p>
             </el-col>
           </el-row>
        </div>

        <!-- 优惠券和积分相关代码 -->
        <div class="discount">
          <div id="accordion">
            <div class="coupon-box">
              <div class="icon-box">
                <span class="select-coupon">使用优惠劵：</span>
                <a class="select-icon unselect" :class="use_coupon?'is_selected':''" @click="use_coupon=!use_coupon"><img class="sign is_show_select" src="../../static/image/12.png" alt=""></a>
                <span class="coupon-num">有{{coupon_list.length}}张可用</span>
              </div>
              <p class="sum-price-wrap">商品总金额：<span class="sum-price">¥ {{total_price.toFixed(2)}}元</span></p>
            </div>
            <div id="collapseOne" v-if="use_coupon">
              <ul class="coupon-list" v-if="coupon_list.length>0">
                <li class="coupon-item" @click="check_disable(item.start_time,item.now_time,item.id)" :class="check_coupon(item.start_time,item.now_time,item.id, coupon)" v-for="(item,key) in coupon_list">
                  <p class="coupon-name">{{item.coupon.name}}</p>
                  <p class="coupon-condition" v-if="item.coupon.condition>0">满{{item.coupon.condition}}元可以使用</p>
                  <p class="coupon-condition" v-else>没有使用条件</p>
                  <p class="coupon-time start_time">开始时间：{{item.start_time.replace("T"," ")}}</p>
                  <p class="coupon-time end_time">过期时间：{{item.end_time.replace("T"," ")}}</p>
                </li>
              </ul>
              <div class="no-coupon" v-else>
                <span class="no-coupon-tips">暂无可用优惠券</span>
              </div>
            </div>
          </div>
          <div class="credit-box">
            <label class="my_el_check_box"><el-checkbox class="my_el_checkbox" v-model="use_credit"></el-checkbox></label>
            <p class="discount-num1" v-if="!use_credit">使用我的贝里</p>
            <p class="discount-num2" v-else><span>总积分：{{user_credit}}，抵扣 <el-input-number @change="handleChange"  v-model="credit" :min="0" :max="parseInt(user_credit)" label="请填写积分"></el-input-number>，本次花费{{credit}}分可以抵扣{{credit_price}}元，扣除以后剩余{{parseInt(user_credit-credit)}}积分</span></p>
          </div>
        </div>

        <div class="calc">
            <el-row class="pay-row">
              <el-col :span="4" class="pay-col"><span class="pay-text">支付方式：</span></el-col>
              <el-col :span="8">
                <span class="alipay" v-if="pay_type==1" @click="pay_type=1"><img src="/static/image/alipay2.png" alt=""></span>
                <span class="alipay" v-else @click="pay_type=1"><img src="/static/image/alipay.png" alt=""></span>
                <span class="alipay wechat" v-if="pay_type==2" @click="pay_type=2"><img src="/static/image/wechat2.png" alt=""></span>
                <span class="alipay wechat" v-else @click="pay_type=2"><img src="/static/image/wechat.png" alt=""></span>
              </el-col>
              <el-col :span="8" class="count">实付款： <span>¥{{(total_price-coupon_price-credit_price).toFixed(2)}}</span></el-col>
              <el-col :span="4" class="cart-pay"><span @click="payhander">{{pay_type===1?'支付宝':'微信'}}支付</span></el-col>
            </el-row>
        </div>
    </div>
    <Footer/>
  </div>
</template>

<script>
  import Header from "./common/Header"
  import Footer from "./common/Footer"
  export default {
    name:"Order",
    data(){
      return {
        token:"",
        pay_type: 1,
        credit: 0, // 本次订单使用的积分
        coupon: 0, // 用户选择使用的优惠券ID
        coupon_price: 0, // 优惠券抵扣的金额
        credit_price: 0, // 积分抵扣的金额
        course_list: [],
        total_price: 0,   // 当前订单的价格
        use_coupon:false, // 用户是否选择使用了优惠券
        use_credit:false, // 使用户是否选择使用了积分
        user_credit: 0,   // 当前用户拥有的积分
        coupon_list:[],   // 后端提供的当前用户拥有的优惠券列表
      }
    },
    components:{
      Header,
      Footer,
    },
    watch:{
      use_coupon(){
          if(!this.use_coupon){
              this.coupon = 0; // 当用户收起优惠券列表，则表示取消使用优惠券，当前选择的优惠券归0重置
          }
      },
      coupon(){
          this.use_credit = false; // 当用户使用优惠券时，关闭积分兑换~
          // 在用户选择不同优惠券时，计算当前优惠券产生的抵扣金额
          this.get_coupon_price();
      },
      use_credit(){
          if(!this.use_credit){
              this.credit = 0; // 当用户收起积分选项，则表示取消使用积分，当前抵扣积分重置为0.
          }
      },
      credit(){
          this.check_credit();
          // 在用户调整本次订单兑换的积分时，计算当前积分抵扣的金额
          this.get_credit_price();
      }
    },
    created(){
      this.check_user();
      this.user_credit = sessionStorage.user_credit;
      this.get_selected_course();
      this.get_user_coupon_list();
    },
    methods: {
      check_user(){
          this.token = this.$settings.check_user_login();
          if(!this.token){
              let self = this;
              this.$alert("对不起，您尚未登录!无法访问购物车！","路飞学城",{
                  callback(){
                      self.$router.push("/user/login");
                  }
              })
          }
      },
      get_selected_course(){
          // 获取购物车中勾选的商品信息
          this.$axios.get(`${this.$settings.Host}/cart/order/`,{
              headers:{
                  Authorization: "jwt "+this.token,
              }
          }).then(response=>{
              this.course_list = response.data;
              // 计算当前所有商品总价格
              let total = 0;
              for(let course of this.course_list){
                  total+=parseFloat(course.real_price);
              }
              this.total_price = total;
          }).catch(error=>{
              let self = this;
             this.$alert("获取购物车数据失败!请联系客服工作人员!","路飞学城",{
                 callback(){
                     self.$router.go(-1);
                 }
             });
          });
      },
      payhander(){
        // 订单生成
        this.$axios.post(`${this.$settings.Host}/order/`,{
            pay_type: this.pay_type,
            coupon: this.coupon,
            credit: this.credit,
        },{
            headers:{
                Authorization: "jwt " + this.token,
            }
        }).then(response=>{
            // 去支付
            if(response.data.order_number){
                this.get_pay_url(response.data.order_number);
            }
        }).catch(error=>{
           // 失败
           this.$message.error("对不起，下单失败！请联系客服工作人员！");
        });
      },
      get_pay_url(order_number){
        // 获取支付链接地址
        this.$axios.get(`${this.$settings.Host}/payments/alipay/`,{
            params:{
                order_number: order_number,
            }
        }).then(response=>{
            // 跳转到指定的支付链接地址
            location.assign(response.data.url);
        }).catch(error=>{
            this.$message.error("对不起，未知的错误导致无法进行支付～请联系客服工作人员！")
        })
      },
      get_user_coupon_list(){
          // 获取当前登录用户的ID
          let user_id = localStorage.user_id || sessionStorage.user_id;
          //  获取当前用户拥有的可用的优惠券列表
          this.$axios.get(`${this.$settings.Host}/coupon/`,{
              params:{
                  user_id: user_id,
              },
              headers:{
                  Authorization: "jwt "+ this.token,
              }
          }).then(response=>{
              this.coupon_list = response.data;
          }).catch(error=>{
              this.$message.error("获取优惠券失败！");
          })
      },
      check_coupon(start_time, now_time, coupon_id, current_coupon){
          start_time = (new Date(start_time) - 0) / 1000;

          if( start_time > now_time ){
              return "disable"; // 当前优惠券不可用
          }

          if(current_coupon === coupon_id){
              return "active";
          }

      },
      get_coupon_price(){
          // 当优惠券的id切换为0时，抵扣价格也为0
          if(this.coupon === 0){
              this.coupon_price = 0;
              return false;
          }

          // 获取优惠券的抵扣金额
          for(let item of this.coupon_list){
              if(item.id === this.coupon){
                  let sale = parseFloat(item.coupon.sale.substr(1));
                  if(item.coupon.coupon_type === 0){
                      // 折扣优惠
                      this.coupon_price = this.total_price * (1-sale);
                  }else{
                      // 减免优惠
                      this.coupon_price = sale;
                  }
              }
          }
      },
      check_disable(start_time, now_time, coupon_id){
          // 判断当前优惠券是否可用
          start_time = (new Date(start_time) - 0) / 1000;

          if( start_time > now_time ){
              return false;
          }

          this.coupon = coupon_id;

      },
      get_credit_price(){
          // 计算积分抵扣的金额
          let credit_money = sessionStorage.credit_money; // 积分兑换比例
          this.credit_price = this.credit / credit_money
      },
      check_credit(){

          // 判断积分的时候，是否超额
          // 先比较用户积分和实付金额，提取最小数值
          let credit_money = sessionStorage.credit_money; // 积分兑换比例
          let order_credit = Math.floor((this.total_price - this.coupon_price) * credit_money);
          let min_credit = 0;
          if(order_credit > this.user_credit){
              min_credit = this.user_credit;
          }else{
              min_credit = order_credit;
          }

          if(this.credit >= min_credit){
              this.credit = min_credit;
          }

      },
      handleChange(){

      },
    }
  }
</script>


<style scoped>
  .cart{
    margin-top: 80px;
  }
  .cart-info{
    overflow: hidden;
    width: 1200px;
    margin: auto;
  }
  .cart-top{
    font-size: 18px;
    color: #666;
    margin: 25px 0;
    font-weight: normal;
  }
  .cart-top span{
    font-size: 12px;
    color: #d0d0d0;
    display: inline-block;
  }
  .cart-title{
    background: #F7F7F7;
    height: 70px;
  }
  .calc{
    margin-top: 25px;
    margin-bottom: 40px;
  }

  .calc .count{
    text-align: right;
    margin-right: 10px;
    vertical-align: middle;
  }
  .calc .count span{
    font-size: 36px;
    color: #333;
  }
  .calc .cart-pay{
    margin-top: 5px;
    width: 110px;
    height: 38px;
    outline: none;
    border: none;
    color: #fff;
    line-height: 38px;
    background: #ffc210;
    border-radius: 4px;
    font-size: 16px;
    text-align: center;
    cursor: pointer;
  }
  .cart-item{
    height: 120px;
    line-height: 120px;
    margin-bottom: 30px;
  }
  .course-info img{
    width: 175px;
    height: 115px;
    margin-right: 35px;
    vertical-align: middle;
    float: left;
  }
  .course-info::after{
    clear: both;
  }
  .course-info .course_text{
    float: left;
    line-height: 36px;
  }
  .course-info .course_text .discount_name{
    color: #ffc210;
    display: block;
  }
  .course-price p{
    line-height: 36px;
  }
  .course-price .original_price{
    color: #9b9b9b;
  }
  .alipay{
    display: inline-block;
    height: 48px;
  }
  .alipay img{
    height: 100%;
    width:auto;
  }

  .pay-text{
    display: block;
    text-align: right;
    height: 100%;
    line-height: 100%;
    vertical-align: middle;
    margin-top: 20px;
  }
  /** 优惠券 **/
.coupon-box{
  text-align: left;
  padding-bottom: 22px;
  padding-left:30px;
  border-bottom: 1px solid #e8e8e8;
}
.coupon-box::after{
  content: "";
  display: block;
  clear: both;
}
.icon-box{
  float: left;
}
.icon-box .select-coupon{
  float: left;
  color: #666;
  font-size: 16px;
}
.icon-box::after{
  content:"";
  clear:both;
  display: block;
}
.select-icon{
  width: 20px;
  height: 20px;
  float: left;
}
.select-icon img{
  max-height:100%;
  max-width: 100%;
  margin-top: 2px;
  transform: rotate(-90deg);
  transition: transform .5s;
}
.is_show_select{
  transform: rotate(0deg)!important;
}
.coupon-num{
    height: 22px;
    line-height: 22px;
    padding: 0 5px;
    text-align: center;
    font-size: 12px;
    float: left;
    color: #fff;
    letter-spacing: .27px;
    background: #fa6240;
    border-radius: 2px;
    margin-left: 20px;
}
.sum-price-wrap{
    float: right;
    font-size: 16px;
    color: #4a4a4a;
    margin-right: 45px;
}
.sum-price-wrap .sum-price{
  font-size: 18px;
  color: #fa6240;
}

.no-coupon{
  text-align: center;
  width: 100%;
  padding: 50px 0px;
  align-items: center;
  justify-content: center; /* 文本两端对其 */
  border-bottom: 1px solid rgb(232, 232, 232);
}
.no-coupon-tips{
  font-size: 16px;
  color: #9b9b9b;
}
.credit-box{
  height: 30px;
  margin-top: 40px;
  display: flex;
  align-items: center;
  justify-content: flex-end
}
.my_el_check_box{
  position: relative;
}
.my_el_checkbox{
  margin-right: 10px;
  width: 16px;
  height: 16px;
}
.discount{
  overflow: hidden;
}
.discount-num1{
  color: #9b9b9b;
  font-size: 16px;
  margin-right: 45px;
}
.discount-num2{
  margin-right: 45px;
  font-size: 16px;
  color: #4a4a4a;
}
.sun-coupon-num{
  margin-right: 45px;
  margin-bottom:43px;
  margin-top: 40px;
  font-size: 16px;
  color: #4a4a4a;
  display: inline-block;
  float: right;
}
.sun-coupon-num span{
  font-size: 18px;
  color: #fa6240;
}
.coupon-list{
  margin: 20px 0;
}
.coupon-list::after{
  display: block;
  content:"";
  clear: both;
}
.coupon-item{
  float: left;
  margin: 15px 8px;
  width: 180px;
  height: 100px;
  padding: 5px;
  background-color: #fa3030;
  cursor: pointer;
}
.coupon-list .active{
  background-color: #fa9000;
}
.coupon-list .disable{
  cursor: not-allowed;
  background-color: #fa6060;
}
.coupon-condition{
  font-size: 12px;
  text-align: center;
  color: #fff;
}
.coupon-name{
  color: #fff;
  font-size: 24px;
  text-align: center;
}
.coupon-time{
  text-align: left;
  color: #fff;
  font-size: 12px;
}
.unselect{
  margin-left: 0px;
  transform: rotate(-90deg);
}
.is_selected{
  transform: rotate(-1turn)!important;
}
[class*=" el-icon-"], [class^=el-icon-]{
  font-size: 12px;
}
</style>
```



完成了上面的功能以后,我们就可以在沙箱环境中进行支付宝的付款了,但是我们会接受到支付宝界面那边跳转回来的同步通知结果,跳转回到我们的客户端页面,

返回的结果.,我们不能保证一定是支付宝返回的,所以我们需要对照官方文档,查看这些参数的作用,

https://docs.open.alipay.com/api_1/alipay.trade.page.pay

```bash
http://www.luffycity.cn:8080/payments/alipay/result?charset=utf-8&out_trade_no=2019121018510000000163840&method=alipay.trade.page.pay.return&total_amount=777.70&sign=IaBzsmnfc71%2FidCb57gf9W9WEGzuxulIc0IemyIbY9MOI0VFMUCz4xbQoDO3VBqrevLfB2HHnDJuvKhkZuYnMI5wejv5OUszqBIc%2F639BHkHMaOV5iEj5TA3wGhjyQiycC8SlnYt4ylCpZhhoVaeJq8Qjl0aPUlEM6%2FB59xAHqEf3kqD8yMkk6JvWkbeBsPjYNn9%2BB6DVvP2KJ5MNxs3euvDd4klX1CC8HmHcbDKell9%2BIyCFFXQIda664MPpDNWlC%2BQef7T%2F5ssoDLNn92Mhn66%2BwvQ3ocbx80fHKsKAWyvAHKaW%2ByNAAiPzw%2FlpE4fYidoZpDa7zpkdm%2FhJsigRg%3D%3D&trade_no=2019121022001439881000144496&auth_app_id=2016091600523592&version=1.0&app_id=2016091600523592&sign_type=RSA2&seller_id=2088102175868026&timestamp=2019-12-10%2018%3A51%3A57
```



### 支付成功的模板

Success.vue,代码;

```vue
<template>
  <div class="success">
    <Header/>
    <div class="main">
        <div class="title">
<!--          <img src="../../static/images/right.svg" alt="">-->
          <div class="success-tips">
              <p class="tips1">您已成功购买 1 门课程！</p>
              <p class="tips2">你还可以加入QQ群 <span>747556033</span> 学习交流</p>
          </div>
        </div>
        <div class="order-info">
            <p class="info1"><b>付款时间：</b><span>2019/04/02 10:27</span></p>
            <p class="info2"><b>付款金额：</b><span >0</span></p>
            <p class="info3"><b>课程信息：</b><span><span>《Pycharm使用秘籍》</span></span></p>
        </div>
        <div class="wechat-code">
<!--          <img src="../../static/image/server.cf99f78.png" alt="" class="er">-->
<!--          <p><img src="../../static/image/tan.svg" alt="">重要！微信扫码关注获得学习通知&amp;课程更新提醒！否则将严重影响学习进度和课程体验！</p>-->
        </div>
        <div class="study">
          <span>立即学习</span>
        </div>
    </div>
    <Footer/>
  </div>
</template>

<script>
  import Header from "./common/Header"
  import Footer from "./common/Footer"
  export default{
    name:"Success",
    data(){
      return {
        current_page:0,
      };
    },
    created(){
      // 把地址栏上面的支付结果，转发给后端

    },
    components:{
      Header,
      Footer,
    }
  }
</script>

<style scoped>
.success{
  padding-top: 80px;
}
.main{
    height: 100%;
    padding-top: 25px;
    padding-bottom: 25px;
    margin: 0 auto;
    width: 1200px;
    background: #fff;
}
.main .title{
    display: flex;
    -ms-flex-align: center;
    align-items: center;
    padding: 25px 40px;
    border-bottom: 1px solid #f2f2f2;
}
.main .title .success-tips{
    box-sizing: border-box;
}
.title img{
    vertical-align: middle;
    width: 60px;
    height: 60px;
    margin-right: 40px;
}
.title .success-tips{
    box-sizing: border-box;
}
.title .tips1{
    font-size: 22px;
    color: #000;
}
.title .tips2{
    font-size: 16px;
    color: #4a4a4a;
    letter-spacing: 0;
    text-align: center;
    margin-top: 10px;
}
.title .tips2 span{
    color: #ec6730;
}
.order-info{
    padding: 25px 48px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f2f2f2;
}
.order-info p{
    display: -ms-flexbox;
    display: flex;
    margin-bottom: 10px;
    font-size: 16px;
}
.order-info p b{
  font-weight: 400;
  color: #9d9d9d;
  white-space: nowrap;
}
.wechat-code{
    display: flex;
    -ms-flex-align: center;
    align-items: center;
    padding: 25px 40px;
    border-bottom: 1px solid #f2f2f2;
}
.wechat-code>img{
    width: 100px;
    height: 100px;
    margin-right: 15px;
}
.wechat-code p{
    font-size: 14px;
    color: #d0021b;
    display: -ms-flexbox;
    display: flex;
    -ms-flex-align: center;
    align-items: center;
}
.wechat-code p>img{
    width: 16px;
    height: 16px;
    margin-right: 10px;
}
.study{
      padding: 25px 40px;
}
.study span{
  display: block;
  width: 140px;
  height: 42px;
  text-align: center;
  line-height: 42px;
  cursor: pointer;
  background: #ffc210;
  border-radius: 6px;
  font-size: 16px;
  color: #fff;
}
</style>
```

routers/index.js，路由代码:

```javascript
    {
      path: '/payments/alipay/result',
      name: "Success",
      component: Success,
    },

```



### 后端接受同步支付结果

支付宝会返回的参数如下列表：

```bash
http://www.luffycity.cn:8080/payments/result?
charset=utf8&
out_trade_no=20190929151453000001000020&
method=alipay.trade.page.pay.return&
total_amount=310.00&
sign=kebIZBI%2FpCNXmCivfJPPw21gcobulPZoSh%2BXiHR8l6cgexQi2STG4AZgr%2FEUhvc5kEMacJLvCmBaw1Wqo4WK3sPzbUaPmzq3NshUNzYK2lWTsmOauidNxlk1bK0Q%2FANBfQUkmj6TQjyB5T9QqEnS80KFsDrGrasU%2B%2Fz9W%2FjOCLrSji6TnKhRkI9pqBMdw823ABU75b7zOtXzcXKduO%2B6vsXVvluMzedss9dHs1celxPAWQV9jcKjzq%2F1bPbZcmgAGNQQecoJ%2BFSc3uTmTk24uV39PM54LIlg8aeRlkPNjvhBkJh%2FG0%2BURNDdG2593IFIF%2BUqoU%2F7ixm19dX222GCWg%3D%3D&
trade_no=2019092922001439881000120282&
auth_app_id=2016091600523592&
version=1.0&
app_id=2016091600523592&
sign_type=RSA2&
seller_id=2088102175868026&
timestamp=2019-09-29%2015%3A15%3A53
```



后端实现处理支付宝同步通知结果的视图，代码:

payments/views.py

```python
from rest_framework.views import APIView
from alipay import AliPay
from django.conf import settings
from rest_framework.response import Response
from order.models import Order
from rest_framework import status
from datetime import datetime
from coupon.models import UserCoupon
from django.db import transaction

import logging

log = logging.getLogger("django")

class AlipayAPIView(APIView):
    def get(self,request):
        """获取支付宝的支付地址"""
        # 获取订单号
        order_number = request.query_params.get("order_number")
        # 判断订单是否存在
        try:
            order = Order.objects.get(order_number=order_number)
        except Order.DoesNotExist:
            return Response({"message":"对不起，订单不存在！"}, status=status.HTTP_400_BAD_REQUEST)

        # 初始化支付对象
        alipay = AliPay(
            appid=settings.ALIAPY_CONFIG["appid"],
            app_notify_url=settings.ALIAPY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_path=settings.ALIAPY_CONFIG["app_private_key_path"],
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_path=settings.ALIAPY_CONFIG["alipay_public_key_path"],
            sign_type=settings.ALIAPY_CONFIG["sign_type"],
            debug = settings.ALIAPY_CONFIG["debug"]  # 默认False
        )

        # 调用接口
        order_string = alipay.api_alipay_trade_page_pay(
            out_trade_no=order.order_number,
            total_amount=float(order.real_price),
            subject=order.order_title,
            return_url=settings.ALIAPY_CONFIG["return_url"],
            notify_url=settings.ALIAPY_CONFIG["notify_url"]  # 可选, 不填则使用默认notify url
        )

        url = settings.ALIAPY_CONFIG["gateway_url"] + order_string

        return Response(url)


class AliPayResultAPIView(APIView):
    def get(self,request):
        """处理支付宝同步通知结果"""

        # 初始化支付对象
        alipay = AliPay(
            appid=settings.ALIAPY_CONFIG["appid"],
            app_notify_url=settings.ALIAPY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_path=settings.ALIAPY_CONFIG["app_private_key_path"],
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_path=settings.ALIAPY_CONFIG["alipay_public_key_path"],
            sign_type=settings.ALIAPY_CONFIG["sign_type"],
            debug = settings.ALIAPY_CONFIG["debug"]  # 默认False
        )

        data = request.query_params.dict()
        print(data)
        signature = data.pop("sign")
        # verification
        success = alipay.verify(data, signature)
        if success:
            # 补充支付成功以后的代码
            order_number = data.get("out_trade_no")
            try:
                order = Order.objects.get(order_number=order_number,order_status=0)
            except Order.DoesNotExist:
                return Response({"message": "对不起，支付结果查询失败！订单不存在！"}, status=status.HTTP_400_BAD_REQUEST)

            with transaction.atomic():
                save_id = transaction.savepoint()
                # 更新订单状态、记录支付时间
                try:
                    order.pay_time = datetime.now()
                    order.order_status = 1
                    order.save()

                    # 如果有使用优惠券或者积分，则修改优惠券的使用状态和扣除积分
                    user_coupon_id = order.coupon
                    if user_coupon_id > 0:
                        user_coupon = UserCoupon.objects.get(pk=user_coupon_id,is_use=False, is_show=True,is_deleted=False)
                        user_coupon.is_use = True
                        user_coupon.save()

                    credit = order.credit
                    if credit > 0:
                        user = order.user
                        user.credit -= credit
                        user.save()

                    # 记录用户成功购买课程的记录, 增加课程的购买人数
                    order_detail_list = order.order_courses.all()
                    for order_detail in order_detail_list:
                        """循环本次订单中所有购买的商品课程"""
                        course = order_detail.course
                        course.students+=1
                        course.save()

                except:
                    log.error("订单结果处理出现故障!无法修改订单相关记录的状态")
                    transaction.savepoint_rollback(save_id)
                    return Response({"message":"对不起，更新订单相关记录失败！"},status=status.HTTP_500_INTERNAL_SERVER_ERROR)

        return Response({"message":"支付成功！"})
```



后端完成 支付宝支付结果的处理并更新用户购买商品课程的记录

user/models.py，模型代码：

```python
from course.models import Course
class UserCourse(BaseModel):
    """用户的课程购买记录"""
    pay_choices = (
        (1, '用户购买'),
        (2, '免费活动'),
        (3, '活动赠品'),
        (4, '系统赠送'),
    )
    user = models.ForeignKey(User, related_name='user_courses', on_delete=models.DO_NOTHING, verbose_name="用户")
    course = models.ForeignKey(Course, related_name='course_users', on_delete=models.DO_NOTHING, verbose_name="课程")
    trade_no = models.CharField(max_length=128, null=True, blank=True, verbose_name="支付平台的流水号",
                                help_text="将来依靠流水号到支付平台查账单")
    buy_type = models.SmallIntegerField(choices=pay_choices, default=1, verbose_name="购买方式")
    pay_time = models.DateTimeField(null=True, blank=True, verbose_name="购买时间")
    out_time = models.DateTimeField(null=True, blank=True, verbose_name="过期时间")

    class Meta:
        db_table = 'ly_user_course'
        verbose_name = '课程购买记录'
        verbose_name_plural = verbose_name
```

数据迁移

```python
python manage.py makemigrations
python manage.py migrate
```

在订单结果处理的视图中把用户购买课程逻辑代码加上，payments/views.py，代码：

```python

```



#### 实现同步结果通知的API接口

payment/views.py，视图代码：

```python
from rest_framework.views import APIView
from alipay import AliPay
from django.conf import settings
from rest_framework.response import Response
from order.models import Order
from rest_framework import status
from datetime import datetime
from coupon.models import UserCoupon
from django.db import transaction
from user.models import UserCourse
from course.models import CourseExpire

import logging
log = logging.getLogger("django")

class AlipayAPIView(APIView):
    def get(self,request):
        """获取支付宝的支付地址"""
        # 获取订单号
        order_number = request.query_params.get("order_number")
        # 判断订单是否存在
        try:
            order = Order.objects.get(order_number=order_number)
        except Order.DoesNotExist:
            return Response({"message":"对不起，订单不存在！"}, status=status.HTTP_400_BAD_REQUEST)

        # 初始化支付对象
        alipay = AliPay(
            appid=settings.ALIAPY_CONFIG["appid"],
            app_notify_url=settings.ALIAPY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_path=settings.ALIAPY_CONFIG["app_private_key_path"],
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_path=settings.ALIAPY_CONFIG["alipay_public_key_path"],
            sign_type=settings.ALIAPY_CONFIG["sign_type"],
            debug = settings.ALIAPY_CONFIG["debug"]  # 默认False
        )

        # 调用接口
        order_string = alipay.api_alipay_trade_page_pay(
            out_trade_no=order.order_number,
            total_amount=float(order.real_price),
            subject=order.order_title,
            return_url=settings.ALIAPY_CONFIG["return_url"],
            notify_url=settings.ALIAPY_CONFIG["notify_url"]  # 可选, 不填则使用默认notify url
        )

        url = settings.ALIAPY_CONFIG["gateway_url"] + order_string

        return Response(url)


class AliPayResultAPIView(APIView):
    def get(self,request):
        """处理支付宝同步通知结果"""

        # 初始化支付对象
        alipay = AliPay(
            appid=settings.ALIAPY_CONFIG["appid"],
            app_notify_url=settings.ALIAPY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_path=settings.ALIAPY_CONFIG["app_private_key_path"],
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_path=settings.ALIAPY_CONFIG["alipay_public_key_path"],
            sign_type=settings.ALIAPY_CONFIG["sign_type"],
            debug = settings.ALIAPY_CONFIG["debug"]  # 默认False
        )

        data = request.query_params.dict()
        signature = data.pop("sign")
        # verification
        success = alipay.verify(data, signature)
        if success:
            # 补充支付成功以后的代码
            order_number = data.get("out_trade_no")
            try:
                order = Order.objects.get(order_number=order_number,order_status=0)
            except Order.DoesNotExist:
                return Response({"message": "对不起，支付结果查询失败！订单不存在！"}, status=status.HTTP_400_BAD_REQUEST)

            with transaction.atomic():
                save_id = transaction.savepoint()
                # 更新订单状态、记录支付时间
                try:
                    order.pay_time = datetime.now()
                    order.order_status = 1
                    order.save()

                    # 如果有使用优惠券或者积分，则修改优惠券的使用状态和扣除积分
                    user_coupon_id = order.coupon
                    if user_coupon_id > 0:
                        user_coupon = UserCoupon.objects.get(pk=user_coupon_id,is_use=False, is_show=True,is_deleted=False)
                        user_coupon.is_use = True
                        user_coupon.save()

                    credit = order.credit
                    if credit > 0:
                        user = order.user
                        user.credit -= credit
                        user.save()

                    # 记录用户成功购买课程的记录, 增加课程的购买人数
                    order_detail_list = order.order_courses.all()
                    for order_detail in order_detail_list:
                        """循环本次订单中所有购买的商品课程"""
                        course = order_detail.course
                        course.students+=1
                        course.save()

                        pay_timestamp = order.pay_time.timestamp()
                        if order_detail.expire > 0:
                            # 有效期间购买
                            expire = CourseExpire.objects.get(pk=order_detail.expire)
                            expire_timestamp = expire.expire_time * 24 * 60 * 60
                            out_time = datetime.fromtimestamp(pay_timestamp+expire_timestamp)
                        else:
                            # 永久购买
                            out_time = None

                        UserCourse.objects.create(
                            user_id=user.id,
                            course_id=course.id,
                            trade_no=data.get("trade_no"),
                            buy_type=1,
                            pay_time=order.pay_time,
                            out_time=out_time
                        )

                except:
                    log.error("订单结果处理出现故障!无法修改订单相关记录的状态")
                    transaction.savepoint_rollback(save_id)
                    return Response({"message":"对不起，更新订单相关记录失败！"},status=status.HTTP_500_INTERNAL_SERVER_ERROR)

        return Response({"message":"支付成功！","credit": user.credit})
```

补充：

```python
我们当前完成的项目具有一定特殊性，和传统卖实物商品不一样的时，我们卖的是虚拟商品，所以不存在多次购买同一款商品的，所以后续同学们自己下用户添加商品到购物车时， 判断用户是否曾经购买了当前商品课程，如果在UserCourse中查询到购买记录，则不能添加商品到购物车！！如果查询到商品课程的购买是具有一定有效期的，可以允许追加购买！
```



payment/urls.py，路由代码：

```python
from django.urls import path, re_path
from . import views
urlpatterns = [
    re_path(r'(?P<order_number>\d+)/alipay/', views.AliapyAPIView.as_view() ),
    path(r'alipay/result/', views.AlipayResultAPIView.as_view() ),
]
```



客户端转发支付宝平台返回的同步通知结果,代码:

```vue
<template>
  <div class="success">
    <Header/>
    <div class="main">
        <div class="title">
          <div class="success-tips">
              <p class="tips1">您已成功购买 1 门课程！</p>
              <p class="tips2">你还可以加入QQ群 <span>747556033</span> 学习交流</p>
          </div>
        </div>
        <div class="order-info">
            <p class="info1"><b>付款时间：</b><span>2019/04/02 10:27</span></p>
            <p class="info2"><b>付款金额：</b><span >0</span></p>
            <p class="info3"><b>课程信息：</b><span><span>《Pycharm使用秘籍》</span></span></p>
        </div>
        <div class="wechat-code">
<!--          <img src="../../static/image/server.cf99f78.png" alt="" class="er">-->
<!--          <p><img src="../../static/image/tan.svg" alt="">重要！微信扫码关注获得学习通知&amp;课程更新提醒！否则将严重影响学习进度和课程体验！</p>-->
        </div>
        <div class="study">
          <span>立即学习</span>
        </div>
    </div>
    <Footer/>
  </div>
</template>

<script>
  import Header from "./common/Header"
  import Footer from "./common/Footer"
  export default{
    name:"Success",
    data(){
      return {
        current_page:0,
      };
    },
    created(){
      // 把地址栏上面的支付结果，转发给后端
      this.alipayResultHander();
    },
    methods:{
        alipayResultHander(){
            // 转发支付结果给后端服务器
            this.$axios.get(`${this.$settings.HOST}/payments/alipay/result/`+location.search).then(response=>{
                this.$message.success(response.data.message);
            }).catch(error=>{
                this.$message.error(error.response.data.message);
            })
        }
    },
    components:{
      Header,
      Footer,
    }
  }
</script>

<style scoped>
.success{
  padding-top: 80px;
}
.main{
    height: 100%;
    padding-top: 25px;
    padding-bottom: 25px;
    margin: 0 auto;
    width: 1200px;
    background: #fff;
}
.main .title{
    display: flex;
    -ms-flex-align: center;
    align-items: center;
    padding: 25px 40px;
    border-bottom: 1px solid #f2f2f2;
}
.main .title .success-tips{
    box-sizing: border-box;
}
.title img{
    vertical-align: middle;
    width: 60px;
    height: 60px;
    margin-right: 40px;
}
.title .success-tips{
    box-sizing: border-box;
}
.title .tips1{
    font-size: 22px;
    color: #000;
}
.title .tips2{
    font-size: 16px;
    color: #4a4a4a;
    letter-spacing: 0;
    text-align: center;
    margin-top: 10px;
}
.title .tips2 span{
    color: #ec6730;
}
.order-info{
    padding: 25px 48px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f2f2f2;
}
.order-info p{
    display: -ms-flexbox;
    display: flex;
    margin-bottom: 10px;
    font-size: 16px;
}
.order-info p b{
  font-weight: 400;
  color: #9d9d9d;
  white-space: nowrap;
}
.wechat-code{
    display: flex;
    -ms-flex-align: center;
    align-items: center;
    padding: 25px 40px;
    border-bottom: 1px solid #f2f2f2;
}
.wechat-code>img{
    width: 100px;
    height: 100px;
    margin-right: 15px;
}
.wechat-code p{
    font-size: 14px;
    color: #d0021b;
    display: -ms-flexbox;
    display: flex;
    -ms-flex-align: center;
    align-items: center;
}
.wechat-code p>img{
    width: 16px;
    height: 16px;
    margin-right: 10px;
}
.study{
      padding: 25px 40px;
}
.study span{
  display: block;
  width: 140px;
  height: 42px;
  text-align: center;
  line-height: 42px;
  cursor: pointer;
  background: #ffc210;
  border-radius: 6px;
  font-size: 16px;
  color: #fff;
}
</style>

```





### 接受异步支付结果

```python
from rest_framework.views import APIView
from alipay import AliPay
from django.conf import settings
from rest_framework.response import Response
from order.models import Order
from rest_framework import status
from datetime import datetime
from coupon.models import UserCoupon
from django.db import transaction
from user.models import UserCourse
from course.models import CourseExpire

import logging
log = logging.getLogger("django")

class AlipayAPIView(APIView):
    def get(self,request):
        """获取支付宝的支付地址"""
        # 获取订单号
        order_number = request.query_params.get("order_number")
        # 判断订单是否存在
        try:
            order = Order.objects.get(order_number=order_number)
        except Order.DoesNotExist:
            return Response({"message":"对不起，订单不存在！"}, status=status.HTTP_400_BAD_REQUEST)

        # 初始化支付对象
        alipay = AliPay(
            appid=settings.ALIAPY_CONFIG["appid"],
            app_notify_url=settings.ALIAPY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_path=settings.ALIAPY_CONFIG["app_private_key_path"],
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_path=settings.ALIAPY_CONFIG["alipay_public_key_path"],
            sign_type=settings.ALIAPY_CONFIG["sign_type"],
            debug = settings.ALIAPY_CONFIG["debug"]  # 默认False
        )

        # 调用接口
        order_string = alipay.api_alipay_trade_page_pay(
            out_trade_no=order.order_number,
            total_amount=float(order.real_price),
            subject=order.order_title,
            return_url=settings.ALIAPY_CONFIG["return_url"],
            notify_url=settings.ALIAPY_CONFIG["notify_url"]  # 可选, 不填则使用默认notify url
        )

        url = settings.ALIAPY_CONFIG["gateway_url"] + order_string

        return Response(url)

from django.http.response import HttpResponse

class AliPayResultAPIView(APIView):
    def get(self,request):
        """处理支付宝同步通知结果"""
        # 初始化支付对象
        alipay = AliPay(
            appid=settings.ALIAPY_CONFIG["appid"],
            app_notify_url=settings.ALIAPY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_path=settings.ALIAPY_CONFIG["app_private_key_path"],
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_path=settings.ALIAPY_CONFIG["alipay_public_key_path"],
            sign_type=settings.ALIAPY_CONFIG["sign_type"],
            debug = settings.ALIAPY_CONFIG["debug"]  # 默认False
        )

        data = request.query_params.dict()
        signature = data.pop("sign")
        # verification
        success = alipay.verify(data, signature)
        if success:
            return self.change_order_status(data)
        return Response({"message":"对不起，当前订单支付失败！"})

    def post(self,request):
        """处理支付宝异步通知结果"""
        # 初始化支付对象
        alipay = AliPay(
            appid=settings.ALIAPY_CONFIG["appid"],
            app_notify_url=settings.ALIAPY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_path=settings.ALIAPY_CONFIG["app_private_key_path"],
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_path=settings.ALIAPY_CONFIG["alipay_public_key_path"],
            sign_type=settings.ALIAPY_CONFIG["sign_type"],
            debug = settings.ALIAPY_CONFIG["debug"]  # 默认False
        )

        data = request.data
        signature = data.pop("sign")
        success = alipay.verify(data, signature)
        if success and data["trade_status"] in ("TRADE_SUCCESS", "TRADE_FINISHED" ):
            response = self.change_order_status(data)
            if "credit" in response.data:
                return HttpResponse("success")

        return Response({"message":"对不起，当前订单支付失败！"})


    def change_order_status(self,data):
        # 补充支付成功以后的代码
        order_number = data.get("out_trade_no")
        try:
            order = Order.objects.get(order_number=order_number, order_status=0)
        except Order.DoesNotExist:
            return Response({"message": "对不起，支付结果查询失败！订单不存在！"}, status=status.HTTP_400_BAD_REQUEST)

        with transaction.atomic():
            save_id = transaction.savepoint()
            # 更新订单状态、记录支付时间
            try:
                order.pay_time = datetime.now()
                order.order_status = 1
                order.save()

                # 如果有使用优惠券或者积分，则修改优惠券的使用状态和扣除积分
                user_coupon_id = order.coupon
                if user_coupon_id > 0:
                    user_coupon = UserCoupon.objects.get(pk=user_coupon_id, is_use=False, is_show=True,
                                                         is_deleted=False)
                    user_coupon.is_use = True
                    user_coupon.save()

                credit = order.credit
                if credit > 0:
                    user = order.user
                    user.credit -= credit
                    user.save()

                # 记录用户成功购买课程的记录, 增加课程的购买人数
                order_detail_list = order.order_courses.all()
                course_list = []
                for order_detail in order_detail_list:
                    """循环本次订单中所有购买的商品课程"""
                    course = order_detail.course
                    course.students += 1
                    course.save()

                    pay_timestamp = order.pay_time.timestamp()
                    if order_detail.expire > 0:
                        # 有效期间购买
                        expire = CourseExpire.objects.get(pk=order_detail.expire)
                        expire_timestamp = expire.expire_time * 24 * 60 * 60
                        out_time = datetime.fromtimestamp(pay_timestamp + expire_timestamp)
                    else:
                        # 永久购买
                        out_time = None

                    UserCourse.objects.create(
                        user_id=user.id,
                        course_id=course.id,
                        trade_no=data.get("trade_no"),
                        buy_type=1,
                        pay_time=order.pay_time,
                        out_time=out_time
                    )

                    course_list.append({
                        "id": course.id,
                        "name": course.name
                    })

            except:
                log.error("订单结果处理出现故障!无法修改订单相关记录的状态")
                transaction.savepoint_rollback(save_id)
                return Response({"message": "对不起，更新订单相关记录失败！"}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

        # 返回结果

        return Response({
            "message": "支付成功！",
            "credit": user.credit,
            "pay_time":order.pay_time,
            "real_price":order.real_price,
            "course_list": course_list
        })
```



#### 支付成功页面展示当前订单信息

api后端视图增加返回数据信息包括课程信息:

```vue
<template>
  <div class="success">
    <Header/>
    <div class="main">
        <div class="title">
          <div class="success-tips">
              <p class="tips1">您已成功购买 {{course_list.length}} 门课程！</p>
              <p class="tips2">你还可以加入QQ群 <span>747556033</span> 学习交流</p>
          </div>
        </div>
        <div class="order-info">
            <p class="info1"><b>付款时间：</b><span>{{pay_time | timeformat}}</span></p>
            <p class="info2"><b>付款金额：</b><span >{{real_price.toFixed(2)}}</span></p>
            <p class="info3"><b>课程信息：</b><span v-for="course in course_list">《<router-link :to="'/courses/detail/'+course.id">{{course.name}}</router-link>》</span></p>
        </div>
        <div class="wechat-code">
<!--          <img src="../../static/image/server.cf99f78.png" alt="" class="er">-->
<!--          <p><img src="../../static/image/tan.svg" alt="">重要！微信扫码关注获得学习通知&amp;课程更新提醒！否则将严重影响学习进度和课程体验！</p>-->
        </div>
        <div class="study">
          <router-link to="/user/learn">立即学习</router-link>
        </div>
    </div>
    <Footer/>
  </div>
</template>

<script>
  import Header from "./common/Header"
  import Footer from "./common/Footer"
  export default{
    name:"Success",
    data(){
      return {
        pay_time: "",
        course_list:[],
        real_price:0,
      };
    },
    created(){
      // 把地址栏上面的支付结果，转发给后端
      this.alipayResultHander();
    },
    filters:{
        timeformat(value){
            let datetime = new Date(value);
            let Y = datetime.getFullYear(); // 年
            let m = datetime.getMonth()+1;
            let d = datetime.getDate();
            let H = datetime.getHours();
            let M = datetime.getMinutes();
            let S = datetime.getSeconds();
            m = m<10?'0'+m:m;
            d = d<10?'0'+d:d;
            H = H<10?'0'+H:H;
            M = M<10?'0'+M:M;
            S = S<10?'0'+S:S;
            return `${Y}-${m}-${d} ${H}:${M}`;
        }
    },
    methods:{
        alipayResultHander(){
            // 转发支付结果给后端服务器
            this.$axios.get(`${this.$settings.HOST}/payments/alipay/result/`+location.search).then(response=>{
                this.$message.success(response.data.message);
                localStorage.user_credit = response.data.credit;
                this.real_price = response.data.real_price;
                this.pay_time = response.data.pay_time;
                this.course_list = response.data.course_list;
            }).catch(error=>{
                this.$message.error(error.response.data.message);
                this.$router.go(-1);
            })
        }
    },
    components:{
      Header,
      Footer,
    }
  }
</script>

<style scoped>
.success{
  padding-top: 80px;
}
.main{
    height: 100%;
    padding-top: 25px;
    padding-bottom: 25px;
    margin: 0 auto;
    width: 1200px;
    background: #fff;
}
.main .title{
    display: flex;
    -ms-flex-align: center;
    align-items: center;
    padding: 25px 40px;
    border-bottom: 1px solid #f2f2f2;
}
.main .title .success-tips{
    box-sizing: border-box;
}
.title img{
    vertical-align: middle;
    width: 60px;
    height: 60px;
    margin-right: 40px;
}
.title .success-tips{
    box-sizing: border-box;
}
.title .tips1{
    font-size: 22px;
    color: #000;
}
.title .tips2{
    font-size: 16px;
    color: #4a4a4a;
    letter-spacing: 0;
    text-align: center;
    margin-top: 10px;
}
.title .tips2 span{
    color: #ec6730;
}
.order-info{
    padding: 25px 48px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f2f2f2;
}
.order-info p{
    display: -ms-flexbox;
    display: flex;
    margin-bottom: 10px;
    font-size: 16px;
}
.order-info p b{
  font-weight: 400;
  color: #9d9d9d;
  white-space: nowrap;
}
.wechat-code{
    display: flex;
    -ms-flex-align: center;
    align-items: center;
    padding: 25px 40px;
    border-bottom: 1px solid #f2f2f2;
}
.wechat-code>img{
    width: 100px;
    height: 100px;
    margin-right: 15px;
}
.wechat-code p{
    font-size: 14px;
    color: #d0021b;
    display: -ms-flexbox;
    display: flex;
    -ms-flex-align: center;
    align-items: center;
}
.wechat-code p>img{
    width: 16px;
    height: 16px;
    margin-right: 10px;
}
.study{
      padding: 25px 40px;
}
.study span{
  display: block;
  width: 140px;
  height: 42px;
  text-align: center;
  line-height: 42px;
  cursor: pointer;
  background: #ffc210;
  border-radius: 6px;
  font-size: 16px;
  color: #fff;
}
</style>
```





##  我的订单

打通头部子组件的链接，代码：

```vue
            <div class="login-box login-box1 full-left">
              <router-link to="">学习中心</router-link>
              <el-menu width="200" class="member el-menu-demo" mode="horizontal">
                  <el-submenu index="2">
                    <template slot="title"><router-link to=""><img src="/static/image/logo@2x.png" alt=""></router-link></template>
                    <el-menu-item index="2-1">我的账户</el-menu-item>
                    <el-menu-item index="2-2"><router-link to="/user/order">我的订单</router-link></el-menu-item>
                    <el-menu-item index="2-3">我的优惠卷</el-menu-item>
                    <el-menu-item index="2-3"><span @click="logoutHander">退出登录</span></el-menu-item>
                  </el-submenu>
                </el-menu>
            </div>
```



前端显示我的订单页面，代码：

```vue
<template>
  <div class="user-order">
    <Header/>
    <div class="main">
        <div class="banner"></div>
          <div class="profile">
              <div class="profile-info">
                  <div class="avatar"><img class="newImg" width="100%" alt="" src="../../static/image/logo@2x.png"></div>
                  <span class="user-name">Mixtea</span>
                  <span class="user-job">深圳市 | 程序员</span>
              </div>
              <ul class="my-item">
                  <li>我的账户</li>
                  <li class="active">我的订单</li>
                  <li>个人资料</li>
                  <li>账号安全</li>
              </ul>
            </div>
            <div class="user-data">
              <ul class="nav">
                <li class="order-info">订单</li>
                <li class="course-expire">有效期</li>
                <li class="course-price">课程价格</li>
                <li class="real-price">实付金额</li>
                <li class="order-status">交易状态</li>
                <li class="order-do">交易操作</li>
              </ul>
              <div class="my-order-item">
                  <div class="user-data-header">
                    <span class="order-time">2019-04-02 10:27:49</span>
                    <span class="order-num">订单号：
                        <span class="my-older-number">20190402102749606</span>
                    </span>
                  </div>
                  <ul class="nav user-data-list">
                <li class="order-info">
                    <img src="../../static/image/course-cover.jpeg" alt="">
                    <div class="order-info-title">
                      <p class="course-title">Pycharm使用秘籍</p>
                      <p class="price-service">限时免费</p>
                    </div>
                </li>
                <li class="course-expire">永久有效</li>
                <li class="course-price">977.00</li>
                <li class="real-price">577.00</li>
                <li class="order-status">交易成功</li>
                <li class="order-do">
                  <span class="btn btn2">去学习</span>
                </li>
              </ul>
              </div>
          </div>
    </div>
    <Footer/>
  </div>
</template>

<script>
  import Header from "./common/Header"
  import Footer from "./common/Footer"
  export default{
    name:"UserOrder",
    data(){
      return {
      };
    },
    created(){
      this.check_login();

    },
    methods:{
      check_login(){
        // 检查当前访问者是否登录了！
        let token = localStorage.user_token || sessionStorage.user_token;
        if( !token ){
          this.$alert("对不起，您尚未登录，请登录以后再进行购物车").then(()=>{
            this.$router.push("/user/login");
          });
          return false; // 阻止代码往下执行
        }
        return token;
      },
      get_user_order(){
        // 获取当前登录用户的所有订单
        
      },
    },
    components:{
      Header,
      Footer,
    }
  }
</script>

<style scoped>
.main .banner{
    width: 100%;
    height: 324px;
    background: url(../../static/image/my_bkging.0648ebe.png) no-repeat;
    background-size: cover;
    z-index: 1;
}
.profile{
    width: 1200px;
    margin: 0 auto;
}
.profile-info{
    text-align: center;
    margin-top: -80px;
}
.avatar{
    width: 120px;
    height: 120px;
    border-radius: 60px;
    overflow: hidden;
    margin: 0 auto;
}
.user-name{
    display: block;
    font-size: 24px;
    color: #4a4a4a;
    margin-top: 14px;
}
.user-job{
    display: block;
    font-size: 11px;
    color: #9b9b9b;
 }
.my-item{
    list-style: none;
    line-height: 1.42857143;
    color: #333;
    width: 474px;
    height: 31px;
    display: -ms-flexbox;
    display: flex;
    cursor: pointer;
    margin: 41px auto 0;
    -ms-flex-pack: justify;
    justify-content: space-between;
}
.my-item .active{
    border-bottom: 1px solid #000;
}
.user-data{
    width: 1200px;
    height: auto;
    margin: 0 auto;
    padding-top: 30px;
    border-top: 1px solid #e8e8e8;
    margin-bottom: 63px;
}
.nav{
    width: 100%;
    height: 60px;
    background: #e9e9e9;
    display: -ms-flexbox;
    display: flex;
    -ms-flex-align: center;
    align-items: center;
}
.nav li{
    margin-left: 20px;
    margin-right: 28px;
    height: 60px;
    line-height: 60px;
    list-style: none;
    font-size: 13px;
    color: #333;
    border-bottom: 1px solid #e9e9e9;
  width: 160px;
}
.nav .order-info{ width: 325px; }
.nav .course-expire{ width: 60px; }
.nav .course-price{ width: 130px; }
.user-data-header{
    display: flex;
    height: 44px;
    color: #4a4a4a;
    font-size: 14px;
    background: #f3f3f3;
    -ms-flex-align: center;
    align-items: center;
}
.order-time{
    font-size: 12px;
    display: inline-block;
    margin-left: 20px;
}
.order-num{
    font-size: 12px;
    display: inline-block;
    margin-left: 29px;
}
.user-data-list{
    height: 100%;
    display: flex;
}
.user-data-list{
  background: none;
}
.user-data-list li{
    height: 60px;
    line-height: 60px;
}
.user-data-list .order-info{
    display: flex;
    align-items: center;
    margin-right: 28px;
}
.user-data-list .order-info img{
    max-width: 100px;
    max-height: 75px;
    margin-right: 22px;
}
.course-title{
    width: 203px;
    font-size: 13px;
    color: #333;
    line-height: 20px;
    margin-top: -10px;
}
.order-info-title .price-service{
    line-height: 18px;
}
.price-service{
    font-size: 12px;
    color: #fa6240;
    padding: 0 5px;
    border: 1px solid #fa6240;
    border-radius: 4px;
    margin-top: 4px;
    position: absolute;
}
.order-info-title{
    margin-top: -10px;
}
.user-data-list .course-expire{
    font-size: 12px;
    color: #ff5502;
    width: 60px;
    text-align: center;
}
.btn {
  width: 100px;
  height: 32px;
  font-size: 14px;
  color: #fff;
  background: #ffc210;
  border-radius: 4px;
  border: none;
  outline: none;
  transition: all .25s ease;
  display: inline-block;
  line-height: 32px;
  text-align: center;
  cursor: pointer;
}
</style>
```

路由注册：

```javascript
import Vue from "vue"
import Router from "vue-router"

// 这里导入可以让让用户访问的组件
// vue 中提供了@符号,表示src路径
import Home from "@/components/Home"
import Login from "@/components/Login"
import Register from "@/components/Register"
import Course from "@/components/Course"
import Detail from "@/components/Detail"
import Cart from "@/components/Cart"
import Order from "@/components/Order"
import Success from "@/components/Success"
import UserOrder from "@/components/UserOrder"
Vue.use(Router);

export default new Router({
  // 设置路由模式为‘history’，去掉默认的#
  mode: "history",
  routes:[
    // 路由列表
    {
      path:"/",
      name:"Home",
      component:Home
    },
    {
      path:"/home",
      name:"Home",
      component:Home
    },
    {
      path:"/user/login",
      name:"Login",
      component: Login
    },
    {
      path:"/user/register",
      name:"Register",
      component: Register
    },
    {
      path:"/course",
      name:"Course",
      component: Course
    },
    {
      path:"/course/:course",
      name:"Detail",
      component: Detail
    },
    {
      path:"/cart",
      name:"Cart",
      component: Cart
    },
    {
      path:"/order",
      name:"Order",
      component: Order
    },
    {
      path:"/pay/result",
      name:"Success",
      component: Success
    },
    {
      path:"/user/order",
      name:"UserOrder",
      component: UserOrder
    }
  ]
});
```



#### 后端提供查询当前登录用户的订单列表信息

users/serializers.py，序列化器，代码：

```python
from order.models import Order

class UserOrderModelSerializer(serializers.ModelSerializer):
    class Meta:
        model = Order
        fields = ["id","order_number","order_status","created_time","course_list"]
```

订单模型，提供获取当前订单相关商品课程列表的方法，order/models.py，代码：

```python
class Order(BaseModel):
    """订单模型"""
    status_choices = (
        (0, '未支付'),
        (1, '已支付'),
        (2, '已取消'),
        (3, '超时取消'),
    )
    pay_choices = (
        (0, '支付宝'),
        (1, '微信支付'),
    )
    order_title = models.CharField(max_length=150,verbose_name="订单标题")
    total_price = models.DecimalField(max_digits=6, decimal_places=2, verbose_name="订单总价", default=0)
    real_price = models.DecimalField(max_digits=6, decimal_places=2, verbose_name="实付金额", default=0)
    order_number = models.CharField(max_length=64,verbose_name="订单号")
    order_status = models.SmallIntegerField(choices=status_choices, default=0, verbose_name="订单状态")
    pay_type = models.SmallIntegerField(choices=pay_choices, default=1, verbose_name="支付方式")
    credit = models.IntegerField(default=0, verbose_name="使用的积分数量")
    coupon = models.IntegerField(null=True, verbose_name="用户优惠券ID")
    order_desc = models.TextField(max_length=500, null=True, blank=True, verbose_name="订单描述")
    pay_time = models.DateTimeField(null=True,blank=True, verbose_name="支付时间")
    user = models.ForeignKey(User, related_name='user_orders', on_delete=models.DO_NOTHING,verbose_name="下单用户")

    class Meta:
        db_table="ly_order"
        verbose_name= "订单记录"
        verbose_name_plural= "订单记录"

    def __str__(self):
        return "%s,总价: %s,实付: %s" % (self.order_title, self.total_price, self.real_price)

    @property
    def course_list(self):
        """获取当前订单相关的课程列表"""
        order_course_list = self.order_courses.all()
        data = []
        for detail in order_course_list:
            course = detail.course
            try:
                expire_text = CourseExpire.objects.get(pk=detail.expire).expire_text
            except:
                expire_text = "永久有效"
            data.append({
                "id": course.id,
                "name": course.name,
                "course_img": constants.SERVER_IMAGE_DOMAIN+course.course_img.url,
                "expire_text": expire_text,
                "discount_name": detail.discount_name,
                "price": detail.price,
                "real_price": detail.real_price,
            })

        return data
```



users/views.py，视图代码：

```python
from rest_framework.generics import ListAPIView
from order.models import Order
from .serializers import UserOrderModelSerializer
from rest_framework.permissions import IsAuthenticated
class UserOrderAPIView(ListAPIView):
    serializer_class = UserOrderModelSerializer
    permission_classes = [IsAuthenticated]
    def get_queryset(self):
        return Order.objects.filter(user_id=self.request.user.id)
```



users/urls.py，路由代码：

```python
    path("order/", views.UserOrderAPIView.as_view() ),
```



#### 前端请求获取当前登录用户的订单信息

```vue
<template>
  <div class="user-order">
    <Header/>
    <div class="main">
        <div class="banner"></div>
          <div class="profile">
              <div class="profile-info">
                  <div class="avatar"><img class="newImg" width="100%" alt="" src="../../static/image/logo@2x.png"></div>
                  <span class="user-name">Mixtea</span>
                  <span class="user-job">深圳市 | 程序员</span>
              </div>
              <ul class="my-item">
                  <li>我的账户</li>
                  <li class="active">我的订单</li>
                  <li>个人资料</li>
                  <li>账号安全</li>
              </ul>
            </div>
            <div class="user-data">
              <ul class="nav">
                <li class="order-info">订单</li>
                <li class="course-expire">有效期</li>
                <li class="course-price">课程价格</li>
                <li class="real-price">实付金额</li>
                <li class="order-status">交易状态</li>
                <li class="order-do">交易操作</li>
              </ul>
              <div class="my-order-item" v-for="order in order_list">
                  <div class="user-data-header">
                    <span class="order-time">{{order.created_time}}</span>
                    <span class="order-num">订单号：
                        <span class="my-older-number">{{order.order_number}}</span>
                    </span>
                  </div>
                  <ul class="nav user-data-list" v-for="course in order.course_list">
                    <li class="order-info">
                        <img :src="course.course_img" alt="">
                        <div class="order-info-title">
                          <p class="course-title">{{course.name}}</p>
                          <p class="price-service" v-if="course.discount_name">{{course.discount_name}}</p>
                        </div>
                    </li>
                    <li class="course-expire">{{course.expire_text}}</li>
                    <li class="course-price">{{course.price.toFixed(2)}}</li>
                    <li class="real-price">{{course.real_price.toFixed(2)}}</li>
                    <li class="order-status" v-if="order.order_status==0">等待付款</li>
                    <li class="order-status" v-if="order.order_status==1">交易成功</li>
                    <li class="order-status" v-if="order.order_status==2">订单取消</li>
                    <li class="order-status" v-if="order.order_status==3">超时取消</li>
                    <li class="order-do">
                      <span class="btn btn2" v-if="order.order_status==1">去学习</span>
                      <span class="btn btn2" v-if="order.order_status==0"><span @click="gotopay(order.order_number)">去付款</span></span>
                    </li>
                  </ul>

              </div>
          </div>
    </div>
    <Footer/>
  </div>
</template>

<script>
  import Header from "./common/Header"
  import Footer from "./common/Footer"
  export default{
    name:"UserOrder",
    data(){
      return {
        order_list: [],
      };
    },
    created(){
      this.get_user_order();
    },
    methods:{
      check_login(){
        // 检查当前访问者是否登录了！
        let token = localStorage.user_token || sessionStorage.user_token;
        if( !token ){
          this.$alert("对不起，您尚未登录，请登录以后再进行购物车").then(()=>{
            this.$router.push("/user/login");
          });
          return false; // 阻止代码往下执行
        }
        return token;
      },
      get_user_order(){
        // 获取当前登录用户的所有订单
        let token = this.check_login();
        this.$axios.get(`${this.$settings.HOST}/user/order/`,{
            headers:{
                "Authorization": "jwt " + token,
            }
        }).then(response=>{
            this.order_list = response.data;
        }).catch(error=>{
            console.log(error.response.data);
        })
      },
      gotopay(order_number){
          // 生成支付订单的链接地址
            this.$axios.get(`${this.$settings.HOST}/payments/alipay/`,{
                params:{
                    order_number: order_number,
                }
            }).then(response=>{
                // 返回支付链接地址
                location.href=response.data;
            }).catch(error=>{
                this.$message.error(error.response.data.message);
            })
      }
    },
    components:{
      Header,
      Footer,
    }
  }
</script>

<style scoped>
.main .banner{
    width: 100%;
    height: 324px;
    background: url(../../static/image/my_bkging.0648ebe.png) no-repeat;
    background-size: cover;
    z-index: 1;
}
.profile{
    width: 1200px;
    margin: 0 auto;
}
.profile-info{
    text-align: center;
    margin-top: -80px;
}
.avatar{
    width: 120px;
    height: 120px;
    border-radius: 60px;
    overflow: hidden;
    margin: 0 auto;
}
.user-name{
    display: block;
    font-size: 24px;
    color: #4a4a4a;
    margin-top: 14px;
}
.user-job{
    display: block;
    font-size: 11px;
    color: #9b9b9b;
 }
.my-item{
    list-style: none;
    line-height: 1.42857143;
    color: #333;
    width: 474px;
    height: 31px;
    display: -ms-flexbox;
    display: flex;
    cursor: pointer;
    margin: 41px auto 0;
    -ms-flex-pack: justify;
    justify-content: space-between;
}
.my-item .active{
    border-bottom: 1px solid #000;
}
.user-data{
    width: 1200px;
    height: auto;
    margin: 0 auto;
    padding-top: 30px;
    border-top: 1px solid #e8e8e8;
    margin-bottom: 63px;
}
.nav{
    width: 100%;
    height: 60px;
    background: #e9e9e9;
    display: -ms-flexbox;
    display: flex;
    -ms-flex-align: center;
    align-items: center;
}
.nav li{
    margin-left: 20px;
    margin-right: 28px;
    height: 60px;
    line-height: 60px;
    list-style: none;
    font-size: 13px;
    color: #333;
    border-bottom: 1px solid #e9e9e9;
  width: 160px;
}
.nav .order-info{ width: 325px; }
.nav .course-expire{ width: 60px; }
.nav .course-price{ width: 130px; }
.user-data-header{
    display: flex;
    height: 44px;
    color: #4a4a4a;
    font-size: 14px;
    background: #f3f3f3;
    -ms-flex-align: center;
    align-items: center;
}
.order-time{
    font-size: 12px;
    display: inline-block;
    margin-left: 20px;
}
.order-num{
    font-size: 12px;
    display: inline-block;
    margin-left: 29px;
}
.user-data-list{
    height: 100%;
    display: flex;
}
.user-data-list{
  background: none;
}
.user-data-list li{
    height: 60px;
    line-height: 60px;
}
.user-data-list .order-info{
    display: flex;
    align-items: center;
    margin-right: 28px;
}
.user-data-list .order-info img{
    max-width: 100px;
    max-height: 75px;
    margin-right: 22px;
}
.course-title{
    width: 203px;
    font-size: 13px;
    color: #333;
    line-height: 20px;
    margin-top: -10px;
}
.order-info-title .price-service{
    line-height: 18px;
}
.price-service{
    font-size: 12px;
    color: #fa6240;
    padding: 0 5px;
    border: 1px solid #fa6240;
    border-radius: 4px;
    margin-top: 4px;
    position: absolute;
}
.order-info-title{
    margin-top: -10px;
}
.user-data-list .course-expire{
    font-size: 12px;
    color: #ff5502;
    width: 60px;
    text-align: center;
}
.btn {
  width: 100px;
  height: 32px;
  font-size: 14px;
  color: #fff;
  background: #ffc210;
  border-radius: 4px;
  border: none;
  outline: none;
  transition: all .25s ease;
  display: inline-block;
  line-height: 32px;
  text-align: center;
  cursor: pointer;
}
</style>
```



#### 订单状态显示分析

```
根据订单状态显示:
1. 如果未支付[order.order_stauts==0],则显示"去支付"按钮
2. 如果已支付[order.order_stauts==1],则显示"去学习"按钮
3. 如果未支付,并超过指定时间[12个小时],则显示"超时取消" [Celery / Django-crontab 定时任务 ]
   用户下单在12小时以后自动判断订单状态如果是0,则直接改成3
   
定时任务[crontab]，主要是依靠：操作系统的定时计划或者第三方软件的定时执行
定时任务的常见场景：
   1. 订单超时
   2. 生日邮件[例如，每天凌晨检查当天有没有用户生日，有则发送一份祝福邮件]
   3. 财务统计[例如，每个月的1号，把当月的订单进行统计，生成一个财务记录，保存到数据库中]
   4. 页面缓存[例如，把首页设置为每隔5分钟生成一次缓存]
```



#### 使用Celery的定时任务来完成订单超时功能

Celery官方文档中关于定时任务使用的说明：

```python
http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html
```



在实现定时任务之前，我们需要先简单使用一下。

我们需要新增一个任务目录，例如order

```
celey_tasks/
    ├── sms/
    │   ├── __init__.py
    │   └── tasks.py
    ├── config.py
    ├── __init__.py
    ├── main.py
    ├── order/
    │   ├── __init__.py
    │   └── tasks.py
    └── sms

```

在main.py中，注册任务目录【注意，接下来后面我们使用django的模型处理，所以必须对django的配置进行引入】

```bash
import os

from celery import Celery

# 1. 创建示例对象
app = Celery("luffy")

# 2. 加载配置
app.config_from_object("celery_tasks.config")
# 3. 注册任务[自动搜索并加载任务]
# 参数必须必须是一个列表，里面的每一个任务都是任务的路径名称
# app.autodiscover_tasks(["任务1","任务2"])
app.autodiscover_tasks(["celery_tasks.sms","celery_tasks.order"])

# 4. 在终端下面运行celery命令启动celery
# celery -A 主程序 worker --loglevel=info
# celery -A celery_tasks.main worker --loglevel=info
```

接下来，在order任务目录下， 创建固定名字的任务文件tasks.py，代码：

```python
from celery_tasks.main import app

@app.task(name="check_order")
def check_order():
    print("检查订单是否过期!!!")
```

接下来，我们需要把这个任务设置定时任务，所以需要借助Celery本身提供的Crontab模块。

在配置文件中，对定时任务进行注册：

```python
# 任务队列的链接地址
broker_url = 'redis://127.0.0.1:6379/15'
# 结果队列的链接地址
result_backend = 'redis://127.0.0.1:6379/14'

from celery.schedules import crontab
from .main import app
# 定时任务的调度列表，用于注册定时任务
app.conf.beat_schedule = {
    # Executes every Monday morning at 7:30 a.m.
    'check_order_outtime': {
        # 本次调度的任务
        'task': 'check_order', # 这里的任务名称必须先到main.py中注册
        # 定时任务的调度周期
        # 'schedule': crontab(minute=0, hour=0),   # 每周凌晨00:00
        'schedule': crontab(),   # 每分钟
      	# 'args': (16, 16),  # 注意：任务就是一个函数，所以如果有参数则需要传递
    },
}
```

接下来，我们就可以重启Celery并启用Celery的定时任务调度器

先在终端下，运行celery的定时任务程序，以下命令：

```bash
celery -A celery_tasks.main beat  # ycelery.main 是celery的主应用文件
```

然后再新建一个终端，运行以下命令，上面的命令必须先指定：

```python
celery -A celery_tasks.main worker --loglevel=info
```

注意，使用的时候，如果有时区必须先配置好系统时区。



经过上面的测试以后，我们接下来只需改造上面的任务函数，用于判断修改订单是否超时。

要完成订单的任务功能，如果需要调用django框架的模型操作，那么必须针对django框架进行配置加载和初始化。

main.py，代码：

```python
import os

from celery import Celery

# 1. 创建示例对象
app = Celery("luffy")

# 把celery和django进行组合，识别和加载django的配置文件
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'luffyapi.settings.dev')

# 在当前clery中启动django框架，对django框架进行进行初始化
import django
django.setup()

# 2. 加载配置
app.config_from_object("celery_tasks.config")
# 3. 注册任务[自动搜索并加载任务]
# 参数必须必须是一个列表，里面的每一个任务都是任务的路径名称
# app.autodiscover_tasks(["任务1","任务2"])
app.autodiscover_tasks(["celery_tasks.sms","celery_tasks.order"])

# 4. 在终端下面运行celery命令启动celery
# celery -A 主程序 worker --loglevel=info
# celery -A celery_tasks.main worker --loglevel=info
```

注意，因为在django中是有时区配置的，所以，我们在django框架配置中也要修改时区配置。

任务代码tasks.py的实现：

```python
from celery_tasks.main import app
from orders.models import Order
from datetime import datetime
from django.conf import settings
@app.task(name="check_order")
def check_order():
    # 查询出所有已经超时的订单
    # 超时条件： 当前时间 > (订单生成时间 + 超时时间)   =====>>>>  (当前时间 - 超时时间) > 订单生成时间
    now = datetime.now().timestamp()
    timeout_number = now - settings.ORDER_TIMEOUT
    timeout = datetime.fromtimestamp(timeout_number)
    timeout_order_list = Order.objects.filter(order_status=0, created_time__lte=timeout)
    for order in timeout_order_list:
        order.order_status = 3
        order.save()
```

配置文件，settings/dev.py，代码：

```python
# 设置订单超时超时的时间[单位: 秒]
ORDER_TIMEOUT = 12 * 60 * 60
```



重新启动celery的定时任务模块和celery的主应用程序。



完成项目以后的练手作业:

```python
1. 使用django完成留言板功能
   留言板的数据记录到mysql中，必须能在一个页面中展示所有留言，能够删除留言，添加留言。 

2. 查阅相关资料，完成一个rbac权限系统功能的学习[django本身的admin运营站点中默认集成了rbac]

3. django rest framework中内置了数据缓存功能，主要使用通过详情页视图和列表页视图缓存查询结构，保存到redis中。
   有3个类：xxx,xxx,xxx
    
4. 使用前面vue阶段的作业，todolist，把todolist中的内容保存到redis中。
   能够记录输入任务的时间，并展示到里面的任务后面，使用灰色12像素字体写在计划任务的后面，
   如果 输入任务时间距离当前时间，小于3分钟，则时间显示为"刚刚"
   如果 输入任务时间距离当前时间，大于3分钟，小于5分钟，则时间显示为"不久前"
   如果 输入任务时间距离当前时间，大于5分钟，小于半小时，则时间显示为"x分钟前"
   以此类推...[不知道怎么推的，自己看下微信朋友圈....]
```



