### 后端接受同步支付结果

支付宝会返回的参数如下列表(见返回的url）：

```bash
http://www.luffycity.cn:8080/payments/result?
charset=utf8&
out_trade_no=20190929151453000001000020&
method=alipay.trade.page.pay.return&
total_amount=310.00&
sign=kebIZBI%2FpCNXmCivfJPPw21gcobulPZoSh%2BXiHR8l6cgexQi2STG4AZgr%2FEUhvc5kEMacJLvCmBaw1Wqo4WK3sPzbUaPmzq3NshUNzYK2lWTsmOauidNxlk1bK0Q%2FANBfQUkmj6TQjyB5T9QqEnS80KFsDrGrasU%2B%2Fz9W%2FjOCLrSji6TnKhRkI9pqBMdw823ABU75b7zOtXzcXKduO%2B6vsXVvluMzedss9dHs1celxPAWQV9jcKjzq%2F1bPbZcmgAGNQQecoJ%2BFSc3uTmTk24uV39PM54LIlg8aeRlkPNjvhBkJh%2FG0%2BURNDdG2593IFIF%2BUqoU%2F7ixm19dX222GCWg%3D%3D&
trade_no=2019092922001439881000120282&
auth_app_id=2016091600523592&
version=1.0&
app_id=2016091600523592&
sign_type=RSA2&
seller_id=2088102175868026&
timestamp=2019-09-29%2015%3A15%3A53
```

```bash
http://www.luffycity.cn:8080/payments/alipay/result?
charset=utf8&
out_trade_no=2019121120375800000131965&
method=alipay.trade.page.pay.return&
total_amount=832.50&
sign=Z5zfzT57CMQ7s2pphfSJkUoWT8BPWN7TsRGosrTqdDSwg%2BKSrsgI5Rw2xAjiH6bazPQ2mECTPFrXVM9g6%2BZCglRs%2BNI9ocQKB5%2BO5L2U1KLhRQylcxmVpjZa8nRwEQbh%2FOpHeaAjCDrYkQg7TmmdpfB6ad9cuSSGA4kEnRu6L0dj1KTUCKRMyVuxT4U8APBLzgOHRrDgUd3mrcsuZYVqlcGI%2FytEy%2FZ3quaboVhyQoEIxaXE2Kq%2BCOdh8hQkLr6F44C1CEPMzddZYS6%2BBoXrpszEgJbD0atwsRXuuxtPAuykbERInK7AAjt1d79F1fUpjz4JG8MJCmYF%2FfyAGctZjg%3D%3D&
trade_no=2019121122001471441002412908&
auth_app_id=2016101400686802&
version=1.0&
app_id=2016101400686802&
sign_type=RSA2&
seller_id=2088102179581165&
timestamp=2019-12-11%2020%3A38%3A35
```

后端实现处理支付宝同步通知结果的视图，代码:

payments/views.py增加同步处理支付后的积分、优惠券的class AlipayResultAPIView(APIView)

```python
# Create your views here.
from rest_framework.views import APIView
from alipay import AliPay
from django.conf import settings
from order.models import Order
from rest_framework.response import Response
from rest_framework import status
class AlipayAPIView(APIView):
    def get(self,request):
        """根据订单号生成一个支付宝的链接地址"""
        order_number = request.query_params.get("order_number")
        try:
            order = Order.objects.get(order_number=order_number)
        except Order.DoesNotExist:
            return Response({"message":"当前订单号无效！发起支付失败！"}, status=status.HTTP_400_BAD_REQUEST)

        with open(settings.ALIPAY_CONFIG["app_private_key_path"],"r") as f:
            app_private_key_string = f.read()

        with open(settings.ALIPAY_CONFIG["alipay_public_key_path"], "r") as f:
            alipay_public_key_string = f.read()

        alipay = AliPay(
            appid= settings.ALIPAY_CONFIG["appid"],  # 应用ID
            app_notify_url=settings.ALIPAY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_string=app_private_key_string,
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_string=alipay_public_key_string,
            sign_type=settings.ALIPAY_CONFIG["sign_type"],  # RSA 或者 RSA2
            debug = settings.ALIPAY_CONFIG["debug"]  # 默认False
        )

        # 电脑网站支付，需要跳转到https://openapi.alipay.com/gateway.do? + order_string
        order_string = alipay.api_alipay_trade_page_pay(
            out_trade_no=order.order_number, # 订单号
            total_amount=float(order.real_price),       # 订单价格
            subject=order.order_title,         # 订单标题
            return_url=settings.ALIPAY_CONFIG["return_url"],  # 同步结果回调地址
            notify_url=settings.ALIPAY_CONFIG["notify_url"]  # 异步结果回调地址
        )

        url = settings.ALIPAY_CONFIG["gateway_url"] + order_string

        return Response({"url": url})

from order.models import Order
from coupon.models import UserCoupon
from datetime import datetime
from django.db import transaction

class AlipayResultAPIView(APIView):
    """支付结果的处理,扣除积分,标记使用过的优惠券"""
    def get(self,request):
        """处理同步通知结果"""
        data = request.query_params.dict()
        signature = data.pop("sign")

        with open(settings.ALIPAY_CONFIG["app_private_key_path"],"r") as f:
            app_private_key_string = f.read()

        with open(settings.ALIPAY_CONFIG["alipay_public_key_path"], "r") as f:
            alipay_public_key_string = f.read()

        alipay = AliPay(
            appid=settings.ALIPAY_CONFIG["appid"],  # 应用ID
            app_notify_url=settings.ALIPAY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_string=app_private_key_string,
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_string=alipay_public_key_string,
            sign_type=settings.ALIPAY_CONFIG["sign_type"],  # RSA 或者 RSA2
            debug=settings.ALIPAY_CONFIG["debug"]  # 默认False
        )

        success = alipay.verify(data, signature)
        if success:
            """验证成功"""
            with transaction.atomic():
                save_id = transaction.savepoint()
                # 根据订单号查询对应的订单
                order_number = data.get("out_trade_no")

                order = Order.objects.get(order_number=order_number)
                user = order.user
                if order.order_status == 0:
                    """如果当前订单为未支付，对订单状态进行修改"""
                    order.order_status = 1
                    order.pay_time = datetime.now()
                    order.save()

                    if order.credit > 0:
                        # 扣除积分
                        try:
                            user.credit -= order.credit
                            user.save()
                        except:
                            transaction.savepoint_rollback(save_id)
                            return Response({"message":"修改订单信息失败！"})

                    if order.coupon >0:
                        """切换优惠券状态"""
                        try:
                            user_coupon = UserCoupon.objects.get(pk=order.coupon, is_use=False)
                            user_coupon.is_use = True
                            user_coupon.save()
                        except:
                            transaction.savepoint_rollback(save_id)
                            return Response({"message":"修改订单信息失败！"})

                # 返回相关数据给客户端
                result = {}
                result["pay_time"] = order.pay_time
                result["real_price"] = order.real_price
                result["user_credit"] = user.credit
                result["course_list"] = []
                # todo 给当前订单涉及到课程增加购买记录，课程购买有效使用时间
                order_course = order.order_courses.all()
                for item in order_course:
                    result["course_list"].append({
                        "id": item.course.id,
                        "name": item.course.name,
                    })

            return Response(result)
```



**处理用户支付宝付款后的跳转的页面**

payment/urls.py，路由代码：

```python
from django.urls import path,re_path
from . import views
urlpatterns = [
    path("alipay/",views.AlipayAPIView.as_view()), #点击支付后的跳转,用于生成订单
    path("alipay/result/",views.AlipayAPIView.as_view()), #处理前端success.vue页面发送的get请求
]
```

客户端转发支付宝平台返回的同步通知结果,代码:

```vue
<template>
  <div class="success">
    <Header/>
    <div class="main">
        <div class="title">
          <div class="success-tips">
              <p class="tips1">您已成功购买 {{current_info.course_list.length}} 门课程！</p>
              <p class="tips2">你还可以加入QQ群 <span>747556033</span> 学习交流</p>
          </div>
        </div>
        <div class="order-info">
            <p class="info1"><b>付款时间：</b><span>{{current_info.pay_time}}</span></p>
            <p class="info2"><b>付款金额：</b><span >{{current_info.real_price}}</span></p>
            <p class="info3"><b>课程信息：</b><span>
              <router-link :to="`/course/${course.id}/`" v-for="course in current_info.course_list">《{{course.name}}》</router-link>
            </span></p>
        </div>
        <div class="wechat-code">

        </div>
        <div class="study">
          <span>立即学习</span>
        </div>
    </div>
    <Footer/>
  </div>
</template>

<script>
  import Header from "./common/Header"
  import Footer from "./common/Footer"
  export default{
    name:"Success",
    data(){
      return {
        current_info:{
            course_list:[],
        },
      };
    },
    created(){
      // 把地址栏上面的支付结果，转发给后端
        this.get_return_url_result();
    },
    methods:{
        get_return_url_result(){
          //  转发结果给后端服务器
          let params = location.search;
          this.$axios.get(`${this.$settings.Host}/payments/alipay/result/${params}`).then(response=>{
               this.current_info = response.data;
               // 把最新的积分保存本地存储中
              sessionStorage.user_credit = response.data.user_credit;
              let datetime = new Date(this.current_info.pay_time);
              this.current_info.pay_time = datetime.toLocaleDateString()+" "+datetime.getHours()+":"+datetime.getMinutes();
          }).catch(error=>{
               this.$message.error("订单支付以后的状态无法获取!");
          })
        },
    },
    components:{
      Header,
      Footer,
    }
  }
</script>

<style scoped>
.success{
  padding-top: 80px;
}
.main{
    height: 100%;
    padding-top: 25px;
    padding-bottom: 25px;
    margin: 0 auto;
    width: 1200px;
    background: #fff;
}
.main .title{
    display: flex;
    -ms-flex-align: center;
    align-items: center;
    padding: 25px 40px;
    border-bottom: 1px solid #f2f2f2;
}
.main .title .success-tips{
    box-sizing: border-box;
}
.title img{
    vertical-align: middle;
    width: 60px;
    height: 60px;
    margin-right: 40px;
}
.title .success-tips{
    box-sizing: border-box;
}
.title .tips1{
    font-size: 22px;
    color: #000;
}
.title .tips2{
    font-size: 16px;
    color: #4a4a4a;
    letter-spacing: 0;
    text-align: center;
    margin-top: 10px;
}
.title .tips2 span{
    color: #ec6730;
}
.order-info{
    padding: 25px 48px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f2f2f2;
}
.order-info p{
    display: -ms-flexbox;
    display: flex;
    margin-bottom: 10px;
    font-size: 16px;
}
.order-info p b{
  font-weight: 400;
  color: #9d9d9d;
  white-space: nowrap;
}
.wechat-code{
    display: flex;
    -ms-flex-align: center;
    align-items: center;
    padding: 25px 40px;
    border-bottom: 1px solid #f2f2f2;
}
.wechat-code>img{
    width: 100px;
    height: 100px;
    margin-right: 15px;
}
.wechat-code p{
    font-size: 14px;
    color: #d0021b;
    display: -ms-flexbox;
    display: flex;
    -ms-flex-align: center;
    align-items: center;
}
.wechat-code p>img{
    width: 16px;
    height: 16px;
    margin-right: 10px;
}
.study{
      padding: 25px 40px;
}
.study span{
  display: block;
  width: 140px;
  height: 42px;
  text-align: center;
  line-height: 42px;
  cursor: pointer;
  background: #ffc210;
  border-radius: 6px;
  font-size: 16px;
  color: #fff;
}
</style>
```

后端完成 支付宝支付结果的处理并更新用户购买商品课程的记录

user/models.py，模型代码：

```python
from course.models import Course
class UserCourse(BaseModel):
    """用户的课程购买记录"""
    pay_choices = (
        (1, '用户购买'),
        (2, '免费活动'),
        (3, '活动赠品'),
        (4, '系统赠送'),
    )
    user = models.ForeignKey(User, related_name='user_courses', on_delete=models.DO_NOTHING, verbose_name="用户")
    course = models.ForeignKey(Course, related_name='course_users', on_delete=models.DO_NOTHING, verbose_name="课程")
    trade_no = models.CharField(max_length=128, null=True, blank=True, verbose_name="支付平台的流水号",
                                help_text="将来依靠流水号到支付平台查账单")
    buy_type = models.SmallIntegerField(choices=pay_choices, default=1, verbose_name="购买方式")
    pay_time = models.DateTimeField(null=True, blank=True, verbose_name="购买时间")
    out_time = models.DateTimeField(null=True, blank=True, verbose_name="过期时间")

    class Meta:
        db_table = 'ly_user_course'
        verbose_name = '课程购买记录'
        verbose_name_plural = verbose_name
```

数据迁移

```python
python manage.py makemigrations
python manage.py migrate
```



#### 实现同步结果通知的API接口中添加用户购买课程的记录

payment/views.py，视图AlipayResultAPIView增加代码：

```python
# Create your views here.
from rest_framework.views import APIView
from alipay import AliPay
from django.conf import settings
from order.models import Order
from rest_framework.response import Response
from rest_framework import status
class AlipayAPIView(APIView):
    def get(self,request):
        """根据订单号生成一个支付宝的链接地址"""
        order_number = request.query_params.get("order_number")
        try:
            order = Order.objects.get(order_number=order_number)
        except Order.DoesNotExist:
            return Response({"message":"当前订单号无效！发起支付失败！"}, status=status.HTTP_400_BAD_REQUEST)

        with open(settings.ALIPAY_CONFIG["app_private_key_path"],"r") as f:
            app_private_key_string = f.read()

        with open(settings.ALIPAY_CONFIG["alipay_public_key_path"], "r") as f:
            alipay_public_key_string = f.read()

        alipay = AliPay(
            appid= settings.ALIPAY_CONFIG["appid"],  # 应用ID
            app_notify_url=settings.ALIPAY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_string=app_private_key_string,
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_string=alipay_public_key_string,
            sign_type=settings.ALIPAY_CONFIG["sign_type"],  # RSA 或者 RSA2
            debug = settings.ALIPAY_CONFIG["debug"]  # 默认False
        )

        # 电脑网站支付，需要跳转到https://openapi.alipay.com/gateway.do? + order_string
        order_string = alipay.api_alipay_trade_page_pay(
            out_trade_no=order.order_number, # 订单号
            total_amount=float(order.real_price),       # 订单价格
            subject=order.order_title,         # 订单标题
            return_url=settings.ALIPAY_CONFIG["return_url"],  # 同步结果回调地址
            notify_url=settings.ALIPAY_CONFIG["notify_url"]  # 异步结果回调地址
        )

        url = settings.ALIPAY_CONFIG["gateway_url"] + order_string

        return Response({"url": url})

from order.models import Order
from coupon.models import UserCoupon
from datetime import datetime
from django.db import transaction
from user.models import UserCourse

class AlipayResultAPIView(APIView):
    """支付结果的处理"""
    def get(self,request):
        """处理同步通知结果"""
        data = request.query_params.dict()
        signature = data.pop("sign")

        with open(settings.ALIPAY_CONFIG["app_private_key_path"],"r") as f:
            app_private_key_string = f.read()

        with open(settings.ALIPAY_CONFIG["alipay_public_key_path"], "r") as f:
            alipay_public_key_string = f.read()

        alipay = AliPay(
            appid=settings.ALIPAY_CONFIG["appid"],  # 应用ID
            app_notify_url=settings.ALIPAY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_string=app_private_key_string,
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_string=alipay_public_key_string,
            sign_type=settings.ALIPAY_CONFIG["sign_type"],  # RSA 或者 RSA2
            debug=settings.ALIPAY_CONFIG["debug"]  # 默认False
        )

        success = alipay.verify(data, signature)
        if success:
            """验证成功"""
            with transaction.atomic():
                save_id = transaction.savepoint()
                # 根据订单号查询对应的订单
                order_number = data.get("out_trade_no")

                order = Order.objects.get(order_number=order_number)
                user = order.user
                if order.order_status == 0:
                    """如果当前订单为未支付，对订单状态进行修改"""
                    order.order_status = 1
                    order.pay_time = datetime.now()
                    order.save()

                    if order.credit > 0:
                        # 扣除积分
                        try:
                            user.credit -= order.credit
                            user.save()
                        except:
                            transaction.savepoint_rollback(save_id)
                            return Response({"message":"修改订单信息失败！"})

                    if order.coupon >0:
                        """切换优惠券状态"""
                        try:
                            user_coupon = UserCoupon.objects.get(pk=order.coupon, is_use=False)
                            user_coupon.is_use = True
                            user_coupon.save()
                        except:
                            transaction.savepoint_rollback(save_id)
                            return Response({"message":"修改订单信息失败！"})

                # 返回相关数据给客户端
                result = {}
                result["pay_time"] = order.pay_time
                result["real_price"] = order.real_price
                result["user_credit"] = user.credit
                result["course_list"] = []

                order_course = order.order_courses.all()
                for item in order_course:
                    # 把当前课程添加到购买记录
                    now_time = datetime.now().timestamp()
                    expire = order.order_courses.filter(course=item.course)[0].expire
                    if expire == 0:
                        out_time = "2199-01-01 00:00:00"
                    else:
                        out_time = datetime.fromtimestamp(now_time + expire * 24 * 3600)

                    try:
                        # 1. 用户曾经购买了课程，但是过期了
                        user_course = UserCourse.objects.get(user=user, course=item.course)
                        if user_course.out_time.timestamp() < now_time:
                            # 过期了
                            user_course.trade_no=data.get("trade_no")
                            user_course.buy_type=1
                            user_course.out_time=out_time
                            user_course.pay_time=order.pay_time
                            user_course.save()

                    except:
                        # 2. 用户从来没有购买过当前课程
                        UserCourse.objects.create(
                            user=user,
                            course=item.course,
                            trade_no=data.get("trade_no"),
                            buy_type=1,
                            pay_time=order.pay_time,
                            out_time=out_time,
                        )

                    result["course_list"].append({
                        "id": item.course.id,
                        "name": item.course.name,
                    })

            return Response(result)
```



补充：

```python
我们当前完成的项目具有一定特殊性，和传统卖实物商品不一样的是，我们卖的是虚拟商品，所以不存在多次购买同一款商品的，所以后续同学们自己下用户添加商品到购物车时， 判断用户是否曾经购买了当前商品课程，如果在UserCourse中查询到购买记录，则不能添加商品到购物车！！
```

cart/views.py,代码:

```python
# Create your views here.
from rest_framework.viewsets import ViewSet
from django_redis import get_redis_connection
from rest_framework.response import Response
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
from course.models import Course,CourseExpire
from luffyapi.settings import constants
from user.models import UserCourse
from datetime import datetime
class CartViewSet(ViewSet):
    permission_classes = [IsAuthenticated]
    def post(self,request):
        """添加商品课程到购物车中"""
        """接收客户端提交的数据"""
        user_id = request.user.id
        course_id=request.data.get("course_id")   #对数据进行验证
        expire_time = 0

        # 对当前商品进行查询判断是否已经购买了。并且没有过期。
        try:
            UserCourse.objects.get(user_id=user_id, course_id=course_id,out_time__gte=datetime.now())
            return Response({"对不起，您已经购买了当前课程商品，无需再次购买！"}, status=status.HTTP_400_BAD_REQUEST)
        except:
            pass

        # 打开redis连接
        redis_conn = get_redis_connection("cart")

        # 把商品信息保存到redis中
        redis_conn = get_redis_connection("cart")
        pipe = redis_conn.pipeline()
        pipe.multi()
        pipe.hset("cart_%s" % user_id, course_id, expire_time)
        pipe.sadd("selected_%s" % user_id, course_id) # 默认用户添加商品到购物车时就是默认选中
        pipe.execute()

        cart_num = redis_conn.hlen("cart_%s" % user_id)

        # 返回数据给客户端
        return Response({"cart_num":cart_num},status=status.HTTP_201_CREATED)

    def get(self,request):
        """购物车商品列表"""
        # 1.获取当前用户的id
        user_id = request.user.id

        # 2.在redis中获取当前用户的购物车商品信息
        redis_conn = get_redis_connection("cart")

        cart_hash = redis_conn.hgetall("cart_%s" % user_id)
        selected_set = redis_conn.smembers("selected_%s" % user_id)

        # 要返回给客户端的数据
        data = []

        # 3.在mysql中根据购物车的商品id获取商品其他详细信息
        for course_id_bytes, expire_time_bytes in cart_hash.items():
            course_id = course_id_bytes.decode()
            expire_time = int( expire_time_bytes.decode() )

            try:
                course = Course.objects.get(pk=course_id)
                data.append({
                    "course_id": course.id,
                    "course_img": constants.SERVER_IMAGE_URL + course.course_img.url, # 返回图片的url地址
                    "course_name": course.name,
                    "price": course.real_price(expire_time),
                    "selected": True if course_id_bytes in selected_set else False,
                    "expire_list": course.get_expire_list, # 当前商品课程所有的有效期选项列表
                    "expire": expire_time, # 购物车中当前商品的勾选有效期
                })
            except Course.DoesNotExist:
                pass

        # 4.返回数据给客户端
        return Response(data)

    def change_course_status(self,request):
        """更新用户购物车的商品勾选状态"""
        # 获取客户端的信息
        user_id = request.user.id
        course_id = request.data.get("course_id")
        selected = request.data.get("selected")

        # 连接redis，修改购物车中商品的勾选状态
        redis_conn = get_redis_connection("cart")
        if selected:
            """添加勾选状态"""
            redis_conn.sadd("selected_%s" % user_id, course_id)
        else:
            """取消勾选状态"""
            redis_conn.srem("selected_%s" % user_id, course_id)

        return Response({"message":"切换商品勾选状态成功！"})

    def change_course_expire(self,request):
        """更新用户购物车的商品有效期选项"""
        # 获取客户端的信息[course_id, user_id ,expire_time]
        user_id = request.user.id
        course_id = request.data.get("course_id")
        expire_time = request.data.get("expire_time")

        # 连接redis，修改购物车中商品的有效期选项
        redis_conn = get_redis_connection("cart")
        redis_conn.hset("cart_%s" % user_id, course_id, expire_time)
        return Response({"message": "切换商品有效期选项成功！"})

    def delete(self,request):
        """购物车商品的删除操作"""
        # 1. 获取客户端的信息[course_id, user_id]
        user_id = request.user.id
        course_id = request.query_params.get("course_id")
        # 2. 连接redis，执行删除操作
        redis_conn = get_redis_connection("cart")

        pipe = redis_conn.pipeline()
        pipe.multi()
        pipe.hdel("cart_%s" % user_id, course_id)
        pipe.srem("selected_%s" % user_id, course_id)
        pipe.execute()

        # 3. return
        return Response({"message":"delete success!"},status=status.HTTP_204_NO_CONTENT)

    def get_selected_course(self,request):
        """获取购物车中勾选的商品信息"""
        # 1.获取当前用户的id
        user_id = request.user.id

        # 2.在redis中获取当前用户的购物车商品信息
        redis_conn = get_redis_connection("cart")

        cart_hash = redis_conn.hgetall("cart_%s" % user_id)
        selected_set = redis_conn.smembers("selected_%s" % user_id)

        # 要返回给客户端的数据
        data = []

        # 在mysql中根据购物车的商品id获取商品其他详细信息
        for course_id_bytes in selected_set:
            course_id = course_id_bytes.decode()
            expire_time = int( cart_hash.get(course_id_bytes).decode() )

            try:
                course = Course.objects.get(pk=course_id)
                data.append({
                    "course_id": course.id,
                    "course_img": constants.SERVER_IMAGE_URL + course.course_img.url, # 返回图片的url地址
                    "course_name": course.name,
                    "price": course.original_price(expire_time), # 商品原价
                    "real_price": course.real_price(expire_time), # 折扣以后的价格
                    "selected": True if course_id_bytes in selected_set else False,
                    "discount_name": course.discount_name,
                    "expire_text": CourseExpire.get_expire_text(course_id, expire_time)
                })
            except Course.DoesNotExist:
                pass

        # 4.返回数据给客户端
        return Response(data)
```



### 接受异步支付结果

支付宝异步通知的频率 https://docs.open.alipay.com/194/103296/ : 

```python
程序执行完后必须打印输出“success”（不包含引号）。如果商户反馈给支付宝的字符不是success这7个字符，支付宝服务器会不断重发通知，直到超过24小时22分钟。一般情况下，25小时以内完成8次通知（通知的间隔频率一般是：4m,10m,10m,1h,2h,6h,15h）；
```

payments/views.py增加异步通知的post方法

```python
# Create your views here.
from rest_framework.views import APIView
from alipay import AliPay
from django.conf import settings
from order.models import Order
from rest_framework.response import Response
from rest_framework import status
class AlipayAPIView(APIView):
    def get(self,request):
        """根据订单号生成一个支付宝的链接地址"""
        order_number = request.query_params.get("order_number")
        try:
            order = Order.objects.get(order_number=order_number)
        except Order.DoesNotExist:
            return Response({"message":"当前订单号无效！发起支付失败！"}, status=status.HTTP_400_BAD_REQUEST)

        with open(settings.ALIPAY_CONFIG["app_private_key_path"],"r") as f:
            app_private_key_string = f.read()

        with open(settings.ALIPAY_CONFIG["alipay_public_key_path"], "r") as f:
            alipay_public_key_string = f.read()

        alipay = AliPay(
            appid= settings.ALIPAY_CONFIG["appid"],  # 应用ID
            app_notify_url=settings.ALIPAY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_string=app_private_key_string,
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_string=alipay_public_key_string,
            sign_type=settings.ALIPAY_CONFIG["sign_type"],  # RSA 或者 RSA2
            debug = settings.ALIPAY_CONFIG["debug"]  # 默认False
        )

        # 电脑网站支付，需要跳转到https://openapi.alipay.com/gateway.do? + order_string
        order_string = alipay.api_alipay_trade_page_pay(
            out_trade_no=order.order_number, # 订单号
            total_amount=float(order.real_price),       # 订单价格
            subject=order.order_title,         # 订单标题
            return_url=settings.ALIPAY_CONFIG["return_url"],  # 同步结果回调地址
            notify_url=settings.ALIPAY_CONFIG["notify_url"]  # 异步结果回调地址
        )

        url = settings.ALIPAY_CONFIG["gateway_url"] + order_string

        return Response({"url": url})

from order.models import Order
from coupon.models import UserCoupon
from datetime import datetime
from django.db import transaction
from user.models import UserCourse
from django.http import HttpResponse

class AlipayResultAPIView(APIView):
    """支付结果的处理"""
    def get(self,request):
        """处理同步通知结果"""
        data = request.query_params.dict()
        success = self.check_alipay_result(data)

        if success:
            """验证成功"""
            return Response( self.pay_result(data) )

    def post(self,request):
        """异步通知结果处理"""
        data = request.data
        success = self.check_alipay_result(data)

        if success and data["trade_status"] in ("TRADE_SUCCESS", "TRADE_FINISHED" ):
            """验证成功"""
            self.pay_result(data)
            return HttpResponse("success") # 此处目的是为了告知支付宝，我们已经成功处理订单信息了

    def pay_result(self,data):
        """验证成功"""
        with transaction.atomic():
            save_id = transaction.savepoint()
            # 根据订单号查询对应的订单
            order_number = data.get("out_trade_no")

            order = Order.objects.get(order_number=order_number)
            user = order.user
            if order.order_status == 0:
                """如果当前订单为未支付，对订单状态进行修改"""
                order.order_status = 1
                order.pay_time = datetime.now()
                order.save()

                if order.credit > 0:
                    # 扣除积分
                    try:
                        user.credit -= order.credit
                        user.save()
                    except:
                        transaction.savepoint_rollback(save_id)
                        return Response({"message": "修改订单信息失败！"})

                if order.coupon > 0:
                    """切换优惠券状态"""
                    try:
                        user_coupon = UserCoupon.objects.get(pk=order.coupon, is_use=False)
                        user_coupon.is_use = True
                        user_coupon.save()
                    except:
                        transaction.savepoint_rollback(save_id)
                        return Response({"message": "修改订单信息失败！"})

            # 返回相关数据给客户端
            result = {}
            result["pay_time"] = order.pay_time
            result["real_price"] = order.real_price
            result["user_credit"] = user.credit
            result["course_list"] = []

            order_course = order.order_courses.all()
            for item in order_course:
                # 把当前课程添加到购买记录
                now_time = datetime.now().timestamp()
                expire = order.order_courses.filter(course=item.course)[0].expire
                if expire == 0:
                    out_time = "2199-01-01 00:00:00"
                else:
                    out_time = datetime.fromtimestamp(now_time + expire * 24 * 3600)

                try:
                    # 1. 用户曾经购买了课程，但是过期了
                    user_course = UserCourse.objects.get(user=user, course=item.course)
                    if user_course.out_time.timestamp() < now_time:
                        # 过期了
                        user_course.trade_no = data.get("trade_no")
                        user_course.buy_type = 1
                        user_course.out_time = out_time
                        user_course.pay_time = order.pay_time
                        user_course.save()

                except:
                    # 2. 用户从来没有购买过当前课程
                    UserCourse.objects.create(
                        user=user,
                        course=item.course,
                        trade_no=data.get("trade_no"),
                        buy_type=1,
                        pay_time=order.pay_time,
                        out_time=out_time,
                    )

                result["course_list"].append({
                    "id": item.course.id,
                    "name": item.course.name,
                })

        return result

    def check_alipay_result(self,data):
        signature = data.pop("sign")

        with open(settings.ALIPAY_CONFIG["app_private_key_path"], "r") as f:
            app_private_key_string = f.read()

        with open(settings.ALIPAY_CONFIG["alipay_public_key_path"], "r") as f:
            alipay_public_key_string = f.read()

        alipay = AliPay(
            appid=settings.ALIPAY_CONFIG["appid"],  # 应用ID
            app_notify_url=settings.ALIPAY_CONFIG["app_notify_url"],  # 默认回调url
            app_private_key_string=app_private_key_string,
            # 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,
            alipay_public_key_string=alipay_public_key_string,
            sign_type=settings.ALIPAY_CONFIG["sign_type"],  # RSA 或者 RSA2
            debug=settings.ALIPAY_CONFIG["debug"]  # 默认False
        )

        return alipay.verify(data, signature)
```



##  我的订单

打通头部子组件的链接，Header.vue,代码：

```vue
            <div class="login-box login-box1 full-left">
              <router-link to="">学习中心</router-link>
              <el-menu width="200" class="member el-menu-demo" mode="horizontal">
                  <el-submenu index="2">
                    <template slot="title"><router-link to=""><img src="/static/image/logo@2x.png" alt=""></router-link></template>
                    <el-menu-item index="2-1">我的账户</el-menu-item>
                    <el-menu-item index="2-2"><router-link to="/user/order">我的订单</router-link></el-menu-item>
                    <el-menu-item index="2-3">我的优惠卷</el-menu-item>
                    <el-menu-item index="2-3"><span @click="logoutHander">退出登录</span></el-menu-item>
                  </el-submenu>
                </el-menu>
            </div>
```



前端显示我的订单页面，代码：

用户的相关页面有多个,所以我们完全把相关的页面组件集中到对应user目录下

user/Order.vue,代码:

```vue
<template>
  <div class="user-order">
    <Header/>
    <div class="main">
        <div class="banner"></div>
          <div class="profile">
              <div class="profile-info">
                  <div class="avatar"><img class="newImg" width="100%" alt="" src="/static/image/logo@2x.png"></div>
                  <span class="user-name">Mixtea</span>
                  <span class="user-job">深圳市 | 程序员</span>
              </div>
              <ul class="my-item">
                  <li>我的账户</li>
                  <li class="active">我的订单</li>
                  <li>个人资料</li>
                  <li>账号安全</li>
              </ul>
            </div>
            <div class="user-data">
              <ul class="nav">
                <li class="order-info">订单</li>
                <li class="course-expire">有效期</li>
                <li class="course-price">课程价格</li>
                <li class="real-price">实付金额</li>
                <li class="order-status">交易状态</li>
                <li class="order-do">交易操作</li>
              </ul>
              <div class="my-order-item">
                  <div class="user-data-header">
                    <span class="order-time">2019-04-02 10:27:49</span>
                    <span class="order-num">订单号：
                        <span class="my-older-number">20190402102749606</span>
                    </span>
                  </div>
                  <ul class="nav user-data-list">
                <li class="order-info">
                    <img src="/static/image/course-cover.jpeg" alt="">
                    <div class="order-info-title">
                      <p class="course-title">Pycharm使用秘籍</p>
                      <p class="price-service">限时免费</p>
                    </div>
                </li>
                <li class="course-expire">永久有效</li>
                <li class="course-price">977.00</li>
                <li class="real-price">577.00</li>
                <li class="order-status">交易成功</li>
                <li class="order-do">
                  <span class="btn btn2">去学习</span>
                </li>
              </ul>
              </div>
          </div>
    </div>
    <Footer/>
  </div>
</template>

<script>
  import Header from "@/components/common/Header"
  import Footer from "@/components/common/Footer"
  export default{
    name:"UserOrder",
    data(){
      return {
      };
    },
    created(){
      this.check_login();

    },
    methods:{
      check_login(){
        // 检查当前访问者是否登录了！
        this.token = this.$settings.check_user_login();
        if( !this.token ){
          this.$alert("对不起，您尚未登录，请登录以后再进入购物车").then(()=>{
            console.log("check_login")
            this.$router.push("/user/login");
          });
          return false; // 阻止代码往下执行
        }
        return this.token;
      },
      get_user_order(){
        // 获取当前登录用户的所有订单

      },
    },
    components:{
      Header,
      Footer,
    }
  }
</script>

<style scoped>
.main .banner{
    width: 100%;
    height: 324px;
    background: url(/static/image/my_bkging.0648ebe.png) no-repeat;
    background-size: cover;
    z-index: 1;
}
.profile{
    width: 1200px;
    margin: 0 auto;
}
.profile-info{
    text-align: center;
    margin-top: -80px;
}
.avatar{
    width: 120px;
    height: 120px;
    border-radius: 60px;
    overflow: hidden;
    margin: 0 auto;
}
.user-name{
    display: block;
    font-size: 24px;
    color: #4a4a4a;
    margin-top: 14px;
}
.user-job{
    display: block;
    font-size: 11px;
    color: #9b9b9b;
 }
.my-item{
    list-style: none;
    line-height: 1.42857143;
    color: #333;
    width: 474px;
    height: 31px;
    display: -ms-flexbox;
    display: flex;
    cursor: pointer;
    margin: 41px auto 0;
    -ms-flex-pack: justify;
    justify-content: space-between;
}
.my-item .active{
    border-bottom: 1px solid #000;
}
.user-data{
    width: 1200px;
    height: auto;
    margin: 0 auto;
    padding-top: 30px;
    border-top: 1px solid #e8e8e8;
    margin-bottom: 63px;
}
.nav{
    width: 100%;
    height: 60px;
    background: #e9e9e9;
    display: -ms-flexbox;
    display: flex;
    -ms-flex-align: center;
    align-items: center;
}
.nav li{
    margin-left: 20px;
    margin-right: 28px;
    height: 60px;
    line-height: 60px;
    list-style: none;
    font-size: 13px;
    color: #333;
    border-bottom: 1px solid #e9e9e9;
  width: 160px;
}
.nav .order-info{ width: 325px; }
.nav .course-expire{ width: 60px; }
.nav .course-price{ width: 130px; }
.user-data-header{
    display: flex;
    height: 44px;
    color: #4a4a4a;
    font-size: 14px;
    background: #f3f3f3;
    -ms-flex-align: center;
    align-items: center;
}
.order-time{
    font-size: 12px;
    display: inline-block;
    margin-left: 20px;
}
.order-num{
    font-size: 12px;
    display: inline-block;
    margin-left: 29px;
}
.user-data-list{
    height: 100%;
    display: flex;
}
.user-data-list{
  background: none;
}
.user-data-list li{
    height: 60px;
    line-height: 60px;
}
.user-data-list .order-info{
    display: flex;
    align-items: center;
    margin-right: 28px;
}
.user-data-list .order-info img{
    max-width: 100px;
    max-height: 75px;
    margin-right: 22px;
}
.course-title{
    width: 203px;
    font-size: 13px;
    color: #333;
    line-height: 20px;
    margin-top: -10px;
}
.order-info-title .price-service{
    line-height: 18px;
}
.price-service{
    font-size: 12px;
    color: #fa6240;
    padding: 0 5px;
    border: 1px solid #fa6240;
    border-radius: 4px;
    margin-top: 4px;
    position: absolute;
}
.order-info-title{
    margin-top: -10px;
}
.user-data-list .course-expire{
    font-size: 12px;
    color: #ff5502;
    width: 60px;
    text-align: center;
}
.btn {
  width: 100px;
  height: 32px;
  font-size: 14px;
  color: #fff;
  background: #ffc210;
  border-radius: 4px;
  border: none;
  outline: none;
  transition: all .25s ease;
  display: inline-block;
  line-height: 32px;
  text-align: center;
  cursor: pointer;
}
</style>
```

路由注册：

```javascript
import UserOrder from "@/components/UserOrder"
Vue.use(Router);

export default new Router({
  // 设置路由模式为‘history’，去掉默认的#
  mode: "history",
  routes:[
    // 路由列表
    {
      path:"/user/order",
      name:"UserOrder",
      component: UserOrder
    }
  ]
});
```



#### 后端提供查询当前登录用户的订单列表信息

users/serializers.py，序列化器，增加代码：

```python
"""我的订单"""
from order.models import Order
class UserOrderModelSerializer(UserModelSerializer):
    class Meta:
        model = Order
        fields = ["id", "order_number", "order_status", "status", "created_time", "course_list"]
```

订单模型，提供获取当前订单相关商品课程列表和当前订单状态文本的方法，order/models.py的Order模型类，代码：

```python
    @property
    def course_list(self):
        """本次下单的课程信息"""
        detail_list = self.order_courses.all()
        data_list = []
        for item in detail_list:
            # 获取课程原价
            original_price = item.course.real_price(item.expire)
            # 获取本次购买课程的有效期文本格式
            try:
                course_expire = CourseExpire.objects.get(course_id=item.course.id, user=self.user_id)
                expire_text = course_expire.expire_text
            except:
                expire_text = "永久有效"

            data_list.append({
                "course_id": item.course.id,
                "course_name": item.course.name,
                "course_img" : item.course.course_img.url,
                "price": original_price,
                "real_price": item.course.discount_price(original_price),
                "expire_text": expire_text,
                "discount_name": item.course.discount_name,
            })

        return data_list

    @property
    def status(self):
        return self.status_choices[self.order_status][1]
```



users/views.py，视图代码：

```python
"""我的订单"""
from rest_framework.generics import ListAPIView
from .serializers import UserOrderModelSerializer
from rest_framework.permissions import IsAuthenticated
class UserOrderAPIView(ListAPIView):
    serializer_class = UserOrderModelSerializer
    permission_classes = [IsAuthenticated]
    def get_queryset(self):
        user = self.request.user
        return user.user_orders.all().order_by("-id")
```



users/urls.py，路由代码：

```python
    path("order/", views.UserOrderAPIView.as_view() ),
```



#### 前端请求获取当前登录用户的订单信息

```vue
<template>
  <div class="user-order">
    <Header/>
    <div class="main">
        <div class="banner"></div>
          <div class="profile">
              <div class="profile-info">
                  <div class="avatar"><img class="newImg" width="100%" alt="" src="/static/image/logo@2x.png"></div>
                  <span class="user-name">Mixtea</span>
                  <span class="user-job">深圳市 | 程序员</span>
              </div>
              <ul class="my-item">
                  <li>我的账户</li>
                  <li class="active">我的订单</li>
                  <li>个人资料</li>
                  <li>账号安全</li>
              </ul>
            </div>
            <div class="user-data">
              <ul class="nav">
                <li class="order-info">订单</li>
                <li class="course-expire">有效期</li>
                <li class="course-price">课程价格</li>
                <li class="real-price">实付金额</li>
                <li class="order-status">交易状态</li>
                <li class="order-do">交易操作</li>
              </ul>
              <div class="my-order-item" v-for="order in order_list">
                  <div class="user-data-header">
                    <span class="order-time">{{order.created_time|date_format}}</span>
                    <span class="order-num">订单号：
                        <span class="my-older-number">{{order.order_number}}</span>
                    </span>
                  </div>
                  <ul class="nav user-data-list" v-for="course in order.course_list">
                      <li class="order-info">
                          <img :src="$settings.Host+course.course_img" alt="">
                          <div class="order-info-title">
                            <p class="course-title">{{course.course_name}}</p>
                            <p class="price-service">{{course.discount_name}}</p>
                          </div>
                      </li>
                      <li class="course-expire">{{course.expire_text}}</li>
                      <li class="course-price">{{parseFloat(course.price).toFixed(2)}}</li>
                      <li class="real-price">{{parseFloat(course.real_price).toFixed(2)}}</li>
                      <li class="order-status">{{order.status}}</li>
                      <li class="order-do">
                        <span class="btn btn2" v-if="order.order_status==0" @click="get_pay_url(order.order_number)">去支付</span>
                        <span class="btn btn2" v-if="order.order_status==0" @click="cancel_order(order.order_number)">取消</span>
                        <span class="btn btn2" v-if="order.order_status==1" @click="go_to_study(course.course_id)">去学习</span>
                      </li>
                  </ul>
              </div>
          </div>
    </div>
    <Footer/>
  </div>
</template>

<script>
  import Header from "@/components/common/Header"
  import Footer from "@/components/common/Footer"
  export default{
    name:"UserOrder",
    data(){
      return {
        token:"",
        order_list:[],
      };
    },
    created(){
      this.check_login();
      this.get_user_order();
    },
    filters:{
        date_format(date){
            date = date.replace("T", " ");
            return date.split(".")[0];
        }
    },
    methods:{
      check_login(){
        // 检查当前访问者是否登录了！
        this.token = this.$settings.check_user_login();
        if( !this.token ){
          this.$alert("对不起，您尚未登录，请登录以后再进入购物车").then(()=>{
            console.log("check_login")
            this.$router.push("/user/login");
          });
          return false; // 阻止代码往下执行
        }
        return this.token;
      },
      get_user_order(){
        // 获取当前登录用户的所有订单
        this.$axios.get(`${this.$settings.Host}/user/order/`,{
           headers:{
               Authorization: "jwt " + this.token,
           }
        }).then(response=>{
            console.log(response.data);
            this.order_list = response.data;
        }).catch(error=>{
            this.$message.error("对不起，获取订单信息失败！");
        })
      },
      get_pay_url(order_number){
        // 获取支付链接地址
        this.$axios.get(`${this.$settings.Host}/payments/alipay/`,{
            params:{
                order_number: order_number,
            }
        }).then(response=>{
            // 跳转到指定的支付链接地址
            location.assign(response.data.url);
        }).catch(error=>{
            this.$message.error("对不起，未知的错误导致无法进行支付～请联系客服工作人员！")
        })
      },
      cancel_order(order_number){
          // 去取消订单
      },
      go_to_study(course_id){
          // 去学习
          this.$router.push(`/player/${course_id}`);
      }
    },
    components:{
      Header,
      Footer,
    }
  }
</script>

<style scoped>
.main .banner{
    width: 100%;
    height: 324px;
    background: url(/static/image/my_bkging.0648ebe.png) no-repeat;
    background-size: cover;
    z-index: 1;
}
.profile{
    width: 1200px;
    margin: 0 auto;
}
.profile-info{
    text-align: center;
    margin-top: -80px;
}
.avatar{
    width: 120px;
    height: 120px;
    border-radius: 60px;
    overflow: hidden;
    margin: 0 auto;
}
.user-name{
    display: block;
    font-size: 24px;
    color: #4a4a4a;
    margin-top: 14px;
}
.user-job{
    display: block;
    font-size: 11px;
    color: #9b9b9b;
 }
.my-item{
    list-style: none;
    line-height: 1.42857143;
    color: #333;
    width: 474px;
    height: 31px;
    display: -ms-flexbox;
    display: flex;
    cursor: pointer;
    margin: 41px auto 0;
    -ms-flex-pack: justify;
    justify-content: space-between;
}
.my-item .active{
    border-bottom: 1px solid #000;
}
.user-data{
    width: 1200px;
    height: auto;
    margin: 0 auto;
    padding-top: 30px;
    border-top: 1px solid #e8e8e8;
    margin-bottom: 63px;
}
.nav{
    width: 100%;
    height: 60px;
    background: #e9e9e9;
    display: -ms-flexbox;
    display: flex;
    -ms-flex-align: center;
    align-items: center;
}
.nav li{
    margin-left: 20px;
    margin-right: 28px;
    height: 60px;
    line-height: 60px;
    list-style: none;
    font-size: 13px;
    color: #333;
    border-bottom: 1px solid #e9e9e9;
  width: 160px;
}
.nav .order-info{ width: 325px; }
.nav .course-expire{ width: 60px; }
.nav .course-price{ width: 130px; }
.user-data-header{
    display: flex;
    height: 44px;
    color: #4a4a4a;
    font-size: 14px;
    background: #f3f3f3;
    -ms-flex-align: center;
    align-items: center;
}
.order-time{
    font-size: 12px;
    display: inline-block;
    margin-left: 20px;
}
.order-num{
    font-size: 12px;
    display: inline-block;
    margin-left: 29px;
}
.user-data-list{
    height: 100%;
    display: flex;
}
.user-data-list{
  background: none;
}
.user-data-list li{
    height: 60px;
    line-height: 60px;
}
.user-data-list .order-info{
    display: flex;
    align-items: center;
    margin-right: 28px;
}
.user-data-list .order-info img{
    max-width: 100px;
    max-height: 75px;
    margin-right: 22px;
}
.course-title{
    width: 203px;
    font-size: 13px;
    color: #333;
    line-height: 20px;
    margin-top: -10px;
}
.order-info-title .price-service{
    line-height: 18px;
}
.price-service{
    font-size: 12px;
    color: #fa6240;
    padding: 0 5px;
    border: 1px solid #fa6240;
    border-radius: 4px;
    margin-top: 4px;
    position: absolute;
}
.order-info-title{
    margin-top: -10px;
}
.user-data-list .course-expire{
    font-size: 12px;
    color: #ff5502;
    width: 60px;
    text-align: center;
}
.btn {
width: 60px;
    height: 24px;
    font-size: 14px;
    color: #fff;
    background: #ffc210;
    border-radius: 4px;
    border: none;
    outline: none;
    -webkit-transition: all .25s ease;
    transition: all .25s ease;
    display: inline-block;
    line-height: 24px;
    text-align: center;
    cursor: pointer;
}
</style>
```



#### 订单状态显示分析

```
根据订单状态显示:
1. 如果未支付[order.order_stauts==0],则显示"去支付"按钮
2. 如果已支付[order.order_stauts==1],则显示"去学习"按钮
3. 如果未支付,并超过指定时间[12个小时],则显示"超时取消" [Celery / Django-crontab 定时任务 ]
   用户下单在12小时以后自动判断订单状态如果是0,则直接改成3
   
定时任务[crontab]，主要是依靠：操作系统的定时计划或者第三方软件的定时执行
定时任务的常见场景：
   1. 订单超时
   2. 生日邮件[例如，每天凌晨检查当天有没有用户生日，有则发送一份祝福邮件]
   3. 财务统计[例如，每个月的1号，把当月的订单进行统计，生成一个财务记录，保存到数据库中]
   4. 页面缓存[例如，把首页设置为每隔5分钟生成一次缓存]
```



#### 使用Celery的定时任务来完成订单超时功能

Celery官方文档中关于定时任务使用的说明：

```python
http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html
```



在实现定时任务之前，我们需要先简单使用一下。

我们需要新增一个任务目录，例如order

```
celey_tasks/
    ├── sms/
    │   ├── __init__.py
    │   └── tasks.py
    ├── config.py
    ├── __init__.py
    ├── main.py
    ├── order/
    │   ├── __init__.py
    │   └── tasks.py
    └── sms

```

在main.py中，注册任务目录【注意，接下来后面我们使用django的模型处理，所以必须对django的配置进行引入】

```bash
import os

from celery import Celery

# 1. 创建示例对象
app = Celery("luffy")

# 2. 加载配置
app.config_from_object("celery_tasks.config")
# 3. 注册任务[自动搜索并加载任务]
# 参数必须必须是一个列表，里面的每一个任务都是任务的路径名称
# app.autodiscover_tasks(["任务1","任务2"])
app.autodiscover_tasks(["celery_tasks.sms","celery_tasks.order"])

# 4. 在终端下面运行celery命令启动celery
# celery -A 主程序 worker --loglevel=info
# celery -A celery_tasks.main worker --loglevel=info
```

接下来，在order任务目录下， 创建固定名字的任务文件tasks.py，代码：

```python
from celery_tasks.main import app

@app.task(name="check_order")
def check_order():
    print("检查订单是否过期!!!")
```

接下来，我们需要把这个任务设置定时任务，所以需要借助Celery本身提供的Crontab模块。

在配置文件中，对定时任务进行注册：

```python
# 任务队列的链接地址
broker_url = 'redis://127.0.0.1:6379/15'
# 结果队列的链接地址
result_backend = 'redis://127.0.0.1:6379/14'

from celery.schedules import crontab
from .main import app
# 定时任务的调度列表，用于注册定时任务
app.conf.beat_schedule = {
    # Executes every Monday morning at 7:30 a.m.
    'check_order_outtime': {
        # 本次调度的任务
        'task': 'check_order', # 这里的任务名称必须先到main.py中注册
        # 定时任务的调度周期
        # 'schedule': crontab(minute=0, hour=0),   # 每周凌晨00:00
        'schedule': crontab(),   # 每分钟
      	# 'args': (16, 16),  # 注意：任务就是一个函数，所以如果有参数则需要传递
    },
}
```

接下来，我们就可以重启Celery并启用Celery的定时任务调度器

先在终端下，运行celery的定时任务程序，以下命令：

```bash
celery -A celery_tasks.main beat  # ycelery.main 是celery的主应用文件
```

然后再新建一个终端，运行以下命令，上面的命令必须先指定：

```python
celery -A celery_tasks.main worker --loglevel=info
```

注意，使用的时候，如果有时区必须先配置好系统时区。



经过上面的测试以后，我们接下来只需改造上面的任务函数，用于判断修改订单是否超时。

要完成订单的任务功能，如果需要调用django框架的模型操作，那么必须针对django框架进行配置加载和初始化。

main.py，代码：

```python
import os

from celery import Celery

# 1. 创建示例对象
app = Celery("luffy")

# 把celery和django进行组合，识别和加载django的配置文件
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'luffyapi.settings.dev')

# 在当前clery中启动django框架，对django框架进行进行初始化
import django
django.setup()

# 2. 加载配置
app.config_from_object("celery_tasks.config")
# 3. 注册任务[自动搜索并加载任务]
# 参数必须必须是一个列表，里面的每一个任务都是任务的路径名称
# app.autodiscover_tasks(["任务1","任务2"])
app.autodiscover_tasks(["celery_tasks.sms","celery_tasks.order"])

# 4. 在终端下面运行celery命令启动celery
# celery -A 主程序 worker --loglevel=info
# celery -A celery_tasks.main worker --loglevel=info
```

注意，因为在django中是有时区配置的，所以，我们在django框架配置中也要修改时区配置。

任务代码tasks.py的实现：

```python
from celery_tasks.main import app
from orders.models import Order
from datetime import datetime
from django.conf import settings
@app.task(name="check_order")
def check_order():
    # 查询出所有已经超时的订单
    # 超时条件： 当前时间 > (订单生成时间 + 超时时间)   =====>>>>  (当前时间 - 超时时间) > 订单生成时间
    now = datetime.now().timestamp()
    timeout_number = now - settings.ORDER_TIMEOUT
    timeout = datetime.fromtimestamp(timeout_number)
    timeout_order_list = Order.objects.filter(order_status=0, created_time__lte=timeout)
    for order in timeout_order_list:
        order.order_status = 3
        order.save()
```

配置文件，settings/dev.py，代码：

```python
# 设置订单超时超时的时间[单位: 秒]
ORDER_TIMEOUT = 12 * 60 * 60
```



重新启动celery的定时任务模块和celery的主应用程序。



完成项目以后的练手作业:

```python
1. 使用django完成留言板功能
   留言板的数据记录到mysql中，必须能在一个页面中展示所有留言，能够删除留言，添加留言。 

2. 查阅相关资料，完成一个rbac权限系统功能的学习[django本身的admin运营站点中默认集成了rbac]

3. django rest framework中内置了数据缓存功能，主要使用通过详情页视图和列表页视图缓存查询结构，保存到redis中。
   有3个类：xxx,xxx,xxx
    
4. 使用前面vue阶段的作业，todolist，把todolist中的内容保存到redis中。
   能够记录输入任务的时间，并展示到里面的任务后面，使用灰色12像素字体写在计划任务的后面，
   如果 输入任务时间距离当前时间，小于3分钟，则时间显示为"刚刚"
   如果 输入任务时间距离当前时间，大于3分钟，小于5分钟，则时间显示为"不久前"
   如果 输入任务时间距离当前时间，大于5分钟，小于半小时，则时间显示为"x分钟前"
   以此类推...[不知道怎么推的，自己看下微信朋友圈....]
```



